<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Muhafiz">
    <meta name="theme-color" content="#1d4ed8">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Muhafiz Dashboard</title>
    <style>
        /* ‚îÄ‚îÄ DESIGN TOKENS ‚îÄ‚îÄ */
        :root {
            --bg-primary:#dce8f5;
            --bg-secondary:#c8d8ec;
            --bg-gradient:linear-gradient(145deg,#d0e2f4 0%,#bdd0e8 50%,#c5d8ef 100%);
            --bg-card:rgba(255,255,255,0.88);
            --glass-border:rgba(255,255,255,0.6);
            --glass-shadow:0 4px 20px rgba(31,65,120,0.10),0 1px 4px rgba(31,65,120,0.06);
            --text-primary:#0f1f3d;
            --text-secondary:#4a6080;
            --border-color:rgba(180,200,230,0.55);
            --shadow-color:rgba(31,65,120,0.08);
            --input-bg:rgba(255,255,255,0.95);
            --header-bg:rgba(255,255,255,0.82);
            --accent:#1d4ed8;
            --accent-light:#dbeafe;
            --accent-glow:rgba(29,78,216,0.18);
        }


        /* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg-gradient);
            background-attachment:fixed;
            min-height:100vh;
            padding:16px 12px;
            -webkit-tap-highlight-color:transparent;
            user-select:none;
            color:var(--text-primary);
        }
        #mainDashboard{transition:opacity 0.2s ease;}

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header{
            display:flex;align-items:center;gap:14px;
            margin-bottom:18px;padding:10px 14px;
            background:var(--header-bg);
            
            border-radius:16px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
        }
        .menu-icon{width:38px;height:38px;display:flex;flex-direction:column;justify-content:space-around;cursor:pointer;padding:7px;flex-shrink:0;}
        .menu-icon span{width:100%;height:2.5px;background-color:var(--text-primary);border-radius:2px;transition:background-color 0.3s;}
        .header-content h1{font-size:22px;font-weight:700;color:var(--text-primary);letter-spacing:-0.3px;}
        .header-content .date{font-size:12px;color:var(--text-secondary);margin-top:1px;}

        /* ‚îÄ‚îÄ DASHBOARD CARDS ‚îÄ‚îÄ */
        .card-wrapper{
            width:100%;
            background:var(--bg-card);
            border-radius:18px;
            margin-bottom:10px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
            transition:transform 0.15s ease,box-shadow 0.15s ease;
            overflow:hidden;
        }
        .card-wrapper:active{transform:scale(0.985);box-shadow:0 2px 10px rgba(31,65,120,0.08);}
        .card{width:100%;padding:16px 22px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;border-radius:18px;transition:background 0.2s;}
        .card:hover{background:rgba(29,78,216,0.04);}
        .card-content h2{font-size:13px;color:var(--text-secondary);font-weight:500;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.4px;}
        .card-content .count{font-size:38px;font-weight:800;line-height:1;}
        .card-icon{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;}

        /* Card colors */
        .files-out .count{color:#1d4ed8;}.files-out .card-icon{background:rgba(219,234,254,0.85);}
        .overdue .count{color:#dc2626;}.overdue .card-icon{background:rgba(254,226,226,0.85);}
        .returned .count{color:#16a34a;}.returned .card-icon{background:rgba(220,252,231,0.85);}
        .pending .count{color:#d97706;}.pending .card-icon{background:rgba(254,243,199,0.85);}
        .completed .count{color:#059669;}.completed .card-icon{background:rgba(209,250,229,0.85);}
        .materials-out .count{color:#7c3aed;}.materials-out .card-icon{background:rgba(237,233,254,0.85);}
        .materials-overdue .count{color:#dc2626;}.materials-overdue .card-icon{background:rgba(254,226,226,0.85);}
        .materials-returned .count{color:#059669;}.materials-returned .card-icon{background:rgba(209,250,229,0.85);}
        .english-file .count{color:#1d4ed8;}.english-file .card-icon{background:rgba(219,234,254,0.85);}
        .bail-bonds .count{color:#7c3aed;}.bail-bonds .card-icon{background:rgba(237,233,254,0.85);}
        .record .count{color:#059669;}.record .card-icon{background:rgba(209,250,229,0.85);}

        /* ‚îÄ‚îÄ NEW ENTRY BUTTON ‚îÄ‚îÄ */
        .new-entry-btn{
            width:100%;background:var(--accent);color:white;border:none;
            border-radius:16px;padding:17px;font-size:17px;font-weight:700;
            cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
            margin-top:24px;
            box-shadow:0 6px 20px var(--accent-glow);
            transition:transform 0.15s,box-shadow 0.15s;
        }
        .new-entry-btn:active{transform:scale(0.97);box-shadow:0 3px 10px var(--accent-glow);}

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar-menu{
            position:fixed;top:0;left:-300px;width:285px;height:100%;
            background:rgba(255,255,255,0.95);
            
            border-right:1px solid var(--glass-border);
            box-shadow:4px 0 28px rgba(15,31,64,0.14);
            transition:left 0.3s cubic-bezier(0.4,0,0.2,1);
            z-index:2000;overflow-y:auto;overflow-x:hidden;
        }

        .sidebar-menu.active{left:0;}
        .sidebar-overlay{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.38);z-index:1999;display:none;
            transition:opacity 0.3s;
        }
        .sidebar-overlay.active{display:block;}
        .sidebar-header{
            padding:18px 18px 16px;
            border-bottom:1px solid var(--border-color);
            display:flex;justify-content:space-between;align-items:center;
            background:var(--header-bg);
            position:sticky;top:0;z-index:10;
        }
        .sidebar-header h2{font-size:17px;font-weight:800;color:var(--accent);letter-spacing:0.3px;}
        .close-sidebar{
            background:rgba(0,0,0,0.06);border:none;width:32px;height:32px;
            border-radius:8px;font-size:20px;cursor:pointer;color:var(--text-secondary);
            display:flex;align-items:center;justify-content:center;
            transition:background 0.15s;
        }
        .close-sidebar:active{background:rgba(0,0,0,0.12);}


        /* Section */
        .sb-section{
            border-bottom:1px solid var(--border-color);
            background:transparent;
        }
        .sb-section-header{
            display:flex;align-items:center;gap:0;
            padding:11px 16px 4px;
        }
        .sb-section-title{
            font-size:10.5px;font-weight:800;
            color:var(--text-secondary);
            text-transform:uppercase;letter-spacing:1px;
            flex:1;
        }
        /* Menu items inside section */
        .menu-item{
            padding:13px 18px 13px 22px;
            display:flex;align-items:center;gap:11px;
            cursor:pointer;font-size:14px;color:var(--text-primary);
            border:none;background:none;width:100%;text-align:left;
            transition:background 0.15s;border-radius:0;
        }
        .menu-item:active{background:rgba(29,78,216,0.07);}
        .menu-item.active{
            background:linear-gradient(90deg,var(--accent-light) 0%,transparent 100%);
            color:var(--accent);font-weight:700;
            border-left:3px solid var(--accent);
            padding-left:19px;
        }


        /* ‚îÄ‚îÄ FORM CONTAINER ‚îÄ‚îÄ */
        .form-container{
            position:fixed;top:0;left:0;right:0;bottom:0;
            background:var(--bg-gradient);
            background-attachment:fixed;
            z-index:1000;overflow-y:auto;padding:16px 12px;
            opacity:0;pointer-events:none;
            transition:opacity 0.18s ease;
        }
        .form-container.active{opacity:1;pointer-events:all;}
        .form-section{
            background:var(--bg-card);
            border-radius:18px;padding:20px;margin-bottom:14px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
            transition:background 0.3s;
        }
        .capture-box{
            border:2px dashed rgba(59,130,246,0.5);
            border-radius:14px;padding:24px 20px;text-align:center;
            cursor:pointer;margin-bottom:18px;min-height:110px;
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:background 0.2s,border-color 0.2s;
        }
        .capture-box:active{background:rgba(59,130,246,0.06);border-color:var(--accent);}
        .camera-icon{font-size:34px;margin-bottom:8px;}
        .capture-text{color:var(--accent);font-size:14px;font-weight:600;}
        .input-field{margin-bottom:18px;}
        .input-field label{display:block;font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:7px;}
        .required{color:#ef4444;}
        .input-field input,.input-field select,.input-field textarea{
            width:100%;padding:13px 14px;font-size:15px;
            border:1.5px solid var(--border-color);border-radius:11px;
            background:var(--input-bg);color:var(--text-primary);
            transition:border-color 0.2s,box-shadow 0.2s;outline:none;
        }
        .input-field input:focus,.input-field select:focus,.input-field textarea:focus{
            border-color:var(--accent);
            box-shadow:0 0 0 3px var(--accent-glow);
        }
        .input-field select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a6080' d='M6 9L1 4h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
        .input-field textarea{resize:vertical;min-height:80px;font-family:inherit;}
        .duration-control{
            display:flex;align-items:center;justify-content:space-between;
            border:1.5px solid var(--border-color);border-radius:11px;padding:10px 14px;
            background:var(--input-bg);
        }
        .duration-btn{background:none;border:none;color:var(--accent);font-size:28px;cursor:pointer;padding:0 8px;transition:opacity 0.15s;}
        .duration-btn:active{opacity:0.6;}
        .duration-value{font-size:17px;font-weight:700;color:var(--text-primary);}
        .form-actions{display:flex;gap:10px;margin-top:20px;}
        .cancel-btn{
            flex:1;padding:15px;font-size:16px;font-weight:600;border:none;
            border-radius:13px;background:var(--bg-card);color:var(--text-primary);
            cursor:pointer;border:1px solid var(--border-color);
            transition:background 0.18s;
        }
        .cancel-btn:active{background:var(--bg-secondary);}
        .save-btn{
            flex:2;padding:15px;font-size:16px;font-weight:700;border:none;
            border-radius:13px;background:var(--accent);color:white;cursor:pointer;
            box-shadow:0 4px 14px var(--accent-glow);
            transition:transform 0.15s,box-shadow 0.15s;
        }
        .save-btn:active{transform:scale(0.97);}

        /* ‚îÄ‚îÄ DETAIL VIEW ‚îÄ‚îÄ */
        .detail-view{
            position:fixed;top:0;left:0;right:0;bottom:0;
            background:var(--bg-gradient);
            background-attachment:fixed;
            z-index:1500;overflow-y:auto;padding:16px 12px;
            opacity:0;pointer-events:none;
            transition:opacity 0.18s ease;
        }
        .detail-view.active{opacity:1;pointer-events:all;}
        .back-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--bg-card);border-radius:10px;font-size:24px;box-shadow:0 2px 8px var(--shadow-color);color:var(--text-primary);flex-shrink:0;border:none;}
        /* ‚îÄ‚îÄ FILE ITEMS (detail view entries) ‚îÄ‚îÄ */
        .file-item{
            background:var(--bg-card);
            
            border-radius:16px;margin-bottom:10px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
            overflow:hidden;
            transition:transform 0.15s;
        }
        .file-item:active{transform:scale(0.99);}
        .file-banner{
            width:100%;padding:11px 16px;
            background:linear-gradient(135deg,#1d4ed8 0%,#1e40af 100%);
            color:white;font-size:14px;font-weight:600;text-align:center;cursor:pointer;
        }
        .file-banner.picture-banner{background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);}
        .file-content{padding:10px 14px;}
        .file-info p{font-size:13px;color:var(--text-secondary);margin:3px 0;line-height:1.4;}
        .file-info p strong{color:var(--text-primary);}
        .file-actions{display:flex;gap:8px;margin-top:10px;}
        .action-btn{
            flex:1;padding:10px;border:none;border-radius:10px;
            font-size:13px;font-weight:700;cursor:pointer;
            transition:transform 0.12s,filter 0.12s;
        }
        .action-btn:active{transform:scale(0.95);filter:brightness(0.9);}
        .call-btn{background:linear-gradient(135deg,#059669,#047857);color:white;}
        .receive-btn{background:linear-gradient(135deg,#1d4ed8,#1e40af);color:white;}
        .delete-btn{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;}
        .overdue-warning{
            background:rgba(254,226,226,0.85);border-left:3px solid #dc2626;
            padding:9px 12px;margin-top:8px;border-radius:8px;
            font-size:12px;color:#991b1b;font-weight:600;
        }

        /* ‚îÄ‚îÄ POPUPS ‚îÄ‚îÄ */
        .popup{
            display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,20,0.5);z-index:3000;
            justify-content:center;align-items:center;padding:20px;
            
        }
        .popup.active{display:flex;}
        .popup-content{
            background:var(--bg-card);
            
            border-radius:22px;padding:28px;max-width:400px;width:100%;
            max-height:82vh;overflow-y:auto;
            border:1px solid var(--glass-border);
            box-shadow:0 8px 40px rgba(0,0,20,0.18);
            transition:background 0.3s;
        }
        .popup-title{font-size:19px;font-weight:700;margin-bottom:18px;text-align:center;color:var(--text-primary);}
        .popup-section{margin-bottom:18px;}
        .popup-actions{display:flex;gap:10px;margin-top:18px;}
        .popup-cancel,.popup-confirm{flex:1;padding:13px;border:none;border-radius:12px;cursor:pointer;font-weight:700;font-size:15px;transition:transform 0.12s;}
        .popup-cancel,.popup-confirm{&:active{transform:scale(0.97);}}
        .popup-cancel{background:rgba(0,0,0,0.06);color:var(--text-primary);}

        .popup-confirm{background:var(--accent);color:white;box-shadow:0 4px 12px var(--accent-glow);}
        .password-input{
            width:100%;padding:14px;font-size:16px;
            border:1.5px solid var(--border-color);border-radius:11px;
            text-align:center;letter-spacing:8px;font-weight:700;
            margin-bottom:18px;background:var(--input-bg);color:var(--text-primary);
        }

        /* ‚îÄ‚îÄ IMAGE MODAL ‚îÄ‚îÄ */
        .image-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.93);z-index:4000;justify-content:center;align-items:center;padding:20px;}
        .image-modal.show{display:flex;}
        .image-modal-content{position:relative;max-width:90%;max-height:90%;}
        .image-modal-content img{width:100%;height:100%;object-fit:contain;border-radius:10px;}
        .close-modal{position:absolute;top:-44px;right:0;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;width:36px;height:36px;border-radius:50%;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary);}
        .empty-state-icon{font-size:44px;margin-bottom:12px;opacity:0.45;}

        /* ‚îÄ‚îÄ FOLDER & DOCUMENT CARDS ‚îÄ‚îÄ */
        .folder-card{
            background:var(--bg-card);
            border-radius:14px;padding:14px 16px;margin-bottom:10px;
            display:flex;align-items:center;gap:12px;cursor:pointer;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
            transition:transform 0.15s,box-shadow 0.15s;
        }
        .folder-card:active{transform:scale(0.97);box-shadow:0 2px 8px var(--shadow-color);}
        .folder-icon{font-size:30px;}
        .folder-info{flex:1;}
        .folder-name{font-size:15px;font-weight:700;color:var(--text-primary);margin-bottom:3px;}
        .folder-count{font-size:12px;color:var(--text-secondary);}
        .folder-arrow{font-size:20px;color:var(--text-secondary);opacity:0.6;}
        .document-card{
            background:var(--bg-card);
            border-radius:14px;padding:14px 16px;margin-bottom:10px;
            display:flex;align-items:center;gap:12px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);cursor:pointer;
            transition:transform 0.15s;
        }
        .document-card:active{transform:scale(0.97);}
        .doc-icon{font-size:28px;}
        .doc-info{flex:1;}
        .doc-name{font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:3px;word-break:break-word;}
        .doc-date{font-size:12px;color:var(--text-secondary);}

        /* ‚îÄ‚îÄ ADD BUTTON ‚îÄ‚îÄ */
        .add-folder-btn{
            width:100%;padding:14px;background:var(--accent);color:white;border:none;
            border-radius:13px;font-size:15px;font-weight:700;cursor:pointer;
            margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:8px;
            box-shadow:0 4px 14px var(--accent-glow);
            transition:transform 0.12s;
        }
        .add-folder-btn:active{transform:scale(0.97);}

        /* ‚îÄ‚îÄ DETAIL HEADER ‚îÄ‚îÄ */
        .detail-header{
            display:flex;align-items:center;gap:12px;
            padding:12px 14px;
            background:var(--header-bg);
            border-bottom:1px solid var(--border-color);
            margin-bottom:14px;border-radius:14px;
            border:1px solid var(--glass-border);
            box-shadow:var(--glass-shadow);
        }
        .detail-header h2{flex:1;color:var(--text-primary);font-size:17px;font-weight:700;}

        /* ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ */
        .back-btn{
            width:38px;height:38px;display:flex;align-items:center;justify-content:center;
            cursor:pointer;background:var(--bg-card);border-radius:10px;font-size:22px;
            border:1px solid var(--glass-border);
            box-shadow:0 2px 8px var(--shadow-color);
            color:var(--text-primary);flex-shrink:0;
            transition:transform 0.12s,background 0.15s;
        }
        .back-btn:active{transform:scale(0.92);background:var(--bg-secondary);}

        /* ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ */
        .context-menu{
            display:none;position:fixed;
            background:var(--bg-card);
            
            border-radius:14px;
            box-shadow:0 6px 28px rgba(0,0,0,0.18);
            border:1px solid var(--glass-border);
            z-index:5000;min-width:165px;overflow:hidden;
        }
        .context-menu.active{display:block;}
        .context-menu-item{padding:13px 18px;display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;border-bottom:1px solid var(--border-color);color:var(--text-primary);transition:background 0.15s;}
        .context-menu-item:last-child{border-bottom:none;}
        .context-menu-item:active{background:rgba(0,0,0,0.06);}
        .context-menu-item.edit{color:var(--accent);}
        .context-menu-item.delete{color:#dc2626;}
        .context-menu-item.share{color:#059669;}

        /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
        .search-container{padding:8px 0 12px;}
        .search-input{
            width:100%;padding:11px 15px;
            border:1.5px solid var(--border-color);border-radius:12px;
            font-size:14px;background:var(--input-bg);color:var(--text-primary);
            transition:border-color 0.2s,box-shadow 0.2s;
        }
        .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}

        /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
        .long-press-hint{font-size:11px;color:var(--text-secondary);font-style:italic;margin-top:6px;text-align:center;opacity:0.7;}
        .action-buttons-row{display:flex;gap:10px;padding:8px 0 12px;}
        .action-btn-option{
            flex:1;padding:12px;border:1.5px solid var(--accent);border-radius:11px;
            background:var(--bg-card);color:var(--accent);font-size:13px;font-weight:700;
            cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;
            transition:background 0.15s,transform 0.12s;
        }
        .action-btn-option:active{background:var(--accent);color:white;transform:scale(0.97);}
        #entryPopup{align-items:center;justify-content:center;}
        .field-group{margin-bottom:14px;}
        .field-group label{display:block;margin-bottom:5px;font-weight:600;font-size:14px;color:var(--text-primary);}
        .field-group input,.field-group select,.field-group textarea{
            width:100%;padding:11px 12px;
            border:1.5px solid var(--border-color);border-radius:10px;
            background:var(--input-bg);color:var(--text-primary);font-size:14px;outline:none;
            transition:border-color 0.2s,box-shadow 0.2s;
        }
        .field-group input:focus,.field-group select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}

        /* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
        .loading-overlay{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,10,30,0.6);
            z-index:9999;display:none;justify-content:center;align-items:center;flex-direction:column;
        }
        .loading-overlay.show{display:flex;}
        .loading-spinner{
            width:48px;height:48px;
            border:3px solid rgba(255,255,255,0.2);
            border-top:3px solid rgba(255,255,255,0.9);
            border-radius:50%;animation:spin 0.7s linear infinite;margin-bottom:14px;
        }
        .loading-text{color:rgba(255,255,255,0.92);font-size:15px;font-weight:600;text-align:center;padding:0 20px;}
        @keyframes spin{to{transform:rotate(360deg);}}
    </style>
</head>
<body>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
<div class="sidebar-menu" id="sidebarMenu">
    <div class="sidebar-header">
        <h2>‚ò∞ Muhafiz</h2>
        <button class="close-sidebar" onclick="closeSidebar()">√ó</button>
    </div>

    <div id="sidebarSections"></div>
</div>

<div id="mainDashboard"></div>
<div class="detail-view" id="detailView"></div>
<div class="form-container" id="formContainer"></div>

<div class="popup" id="confirmPopup">
    <div class="popup-content">
        <div class="popup-title" id="popupTitle">Confirm Action</div>
        <div class="popup-section">
            <p id="popupMessage" style="text-align:center;margin-bottom:20px;color:var(--text-primary);"></p>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter Password" maxlength="4" style="display:none;">
        </div>
        <div class="popup-actions">
            <button class="popup-cancel" onclick="closeConfirmPopup()">Cancel</button>
            <button class="popup-confirm" id="confirmBtn">Confirm</button>
        </div>
    </div>
</div>

<div class="popup" id="entryPopup"></div>

<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" src="" alt="Preview">
    </div>
</div>

<div class="context-menu" id="contextMenu">
    <div class="context-menu-item edit" onclick="handleContextAction('edit')">‚úèÔ∏è Edit</div>
    <div class="context-menu-item share" onclick="handleContextAction('share')">üì§ Share</div>
    <div class="context-menu-item delete" onclick="handleContextAction('delete')">üóëÔ∏è Delete</div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<input type="file" id="importFileInput" accept=".json" style="display:none;">
<input type="file" id="documentFileInput" accept="image/*" multiple style="display:none;">
<input type="file" id="documentCameraInput" accept="image/*" capture="environment" style="display:none;">

<script>
// ============================================================
//  INDEXEDDB ENGINE  ‚Äî unlimited storage, no quota errors
// ============================================================
const DB_NAME = 'MuhafizDB', DB_VER = 1, STORE = 'appData';
let _db = null;
const _cache = {};  // sync read cache populated at startup

function openDB() {
    return new Promise((res, rej) => {
        if (_db) { res(_db); return; }
        const r = indexedDB.open(DB_NAME, DB_VER);
        r.onupgradeneeded = e => {
            if (!e.target.result.objectStoreNames.contains(STORE))
                e.target.result.createObjectStore(STORE, {keyPath:'key'});
        };
        r.onsuccess = e => { _db = e.target.result; res(_db); };
        r.onerror   = e => rej(e.target.error);
    });
}
async function dbGet(key) {
    if (key in _cache) return _cache[key];
    const db = await openDB();
    return new Promise(res => {
        const r = db.transaction(STORE,'readonly').objectStore(STORE).get(key);
        r.onsuccess = () => { const v = r.result ? r.result.value : null; if (v!==null) _cache[key]=v; res(v); };
        r.onerror   = () => res(null);
    });
}
async function dbSet(key, value) {
    _cache[key] = value;
    const db = await openDB();
    return new Promise((res, rej) => {
        const tx = db.transaction(STORE,'readwrite');
        tx.objectStore(STORE).put({key, value});
        tx.oncomplete = res;
        tx.onerror = e => rej(e.target.error);
    });
}
async function dbDel(key) {
    delete _cache[key];
    const db = await openDB();
    return new Promise(res => {
        const tx = db.transaction(STORE,'readwrite');
        tx.objectStore(STORE).delete(key);
        tx.oncomplete = res; tx.onerror = res;
    });
}
async function dbLoadAll() {
    const db = await openDB();
    const all = await new Promise(res => {
        const r = db.transaction(STORE,'readonly').objectStore(STORE).getAll();
        r.onsuccess = () => res(r.result || []);
        r.onerror   = () => res([]);
    });
    all.forEach(item => _cache[item.key] = item.value);
    // Migrate old localStorage data once
    const LS_KEYS = ['filesOut','overdueFiles','returnedFiles','pendingTasks','overdueTasks',
        'completedTasks','materialsOut','materialsOverdue','materialsReturned',
        'englishFile_folders','bailBonds','record_folders','currentMode',
        'currentEntryType','lastCaseType'];
    for (const k of LS_KEYS) {
        if (!(k in _cache)) {
            try { const v = localStorage.getItem(k); if (v) { _cache[k]=v; await dbSet(k,v); localStorage.removeItem(k); } } catch(e){}
        }
    }
}
// Sync read helper (must call dbLoadAll first)
function cacheGet(key) { return _cache[key] || null; }

// ============================================================
//  IMAGE COMPRESSION
// ============================================================
function compressImg(dataUrl, maxW=900, q=0.65) {
    return new Promise(res => {
        if (!dataUrl || !dataUrl.startsWith('data:image')) { res(dataUrl); return; }
        const img = new Image();
        img.onload = () => {
            let w=img.width, h=img.height;
            if (w>maxW) { h=Math.round(h*maxW/w); w=maxW; }
            const c=document.createElement('canvas'); c.width=w; c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            res(c.toDataURL('image/jpeg',q));
        };
        img.onerror = ()=>res(dataUrl);
        img.src = dataUrl;
    });
}
async function fileToCompressed(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = async ev => res(await compressImg(ev.target.result));
        r.onerror = ()=>res(null);
        r.readAsDataURL(file);
    });
}
// For My Documents - NO compression, preserve original quality
async function fileToOriginal(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = ev => res(ev.target.result);
        r.onerror = ()=>res(null);
        r.readAsDataURL(file);
    });
}

// ============================================================
//  LOADING OVERLAY
// ============================================================
function showLoading(txt='Saving...') { document.getElementById('loadingText').textContent=txt; document.getElementById('loadingOverlay').classList.add('show'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }

// ============================================================
//  GLOBALS
// ============================================================
const DURATIONS=['5 Mins','15 Mins','30 Mins','1 Hour','2 Hours','3 Hours','1 Day','2 Days','Enter Date'];
let durIdx=3, curMode='fileMovement', curType='picture';
let liveTimerIv=null, overdueIv=null;
let navStack=[], lpTimer=null, lpData=null;
const LP_DUR=600;

// ============================================================
//  NAV
// ============================================================
function pushNav(s,p){navStack.push({screen:s,params:p});history.pushState({n:navStack.length},'');}
function navBack(){
    if(!navStack.length)return false;
    navStack.pop();
    const prev=navStack[navStack.length-1];
    if(!prev){closeAllViews();return true;}
    restoreNav(prev);return true;
}
function closeAllViews(){
    // Instant remove for back gesture (browser handles animation)
    const _dv=document.getElementById('detailView'),_fc=document.getElementById('formContainer');
    _dv.classList.remove('active');_fc.classList.remove('active');
    document.getElementById('mainDashboard').style.display='block';document.getElementById('mainDashboard').style.opacity='1';
    closePopup();
    document.getElementById('mainDashboard').style.display='block';
}
function restoreNav(nav){
    const s=nav.screen,p=nav.params;
    if(s==='dashboard')closeAllViews();
    else if(s==='detailView')_detailInternal(p.type);
    else if(s==='englishFile')openEnglishFile(true);
    else if(s==='englishFolder')openEnglishFolder(p.folderIndex,true);
    else if(s==='bailBonds')openBailBonds(true);
    else if(s==='record')openRecord(true);
    else if(s==='recordFolder')openRecordFolder(p.folderIndex,true);
}
window.addEventListener('popstate',()=>{
    const ep=document.getElementById('entryPopup');
    const cp=document.getElementById('confirmPopup');
    if(ep.style.display==='flex'){closePopup();history.pushState({},'');return;}
    if(cp.classList.contains('active')){closeConfirmPopup();history.pushState({},'');return;}
    if(document.getElementById('sidebarMenu').classList.contains('active')){closeSidebar();history.pushState({},'');return;}
    if(document.getElementById('imageModal').classList.contains('show')){closeImageModal();history.pushState({},'');return;}
    navBack();
});

// ============================================================
//  INIT
// ============================================================
document.addEventListener('DOMContentLoaded',async()=>{
    document.getElementById('mainDashboard').style.opacity='0';
    try{
        showLoading('Loading...');
        await dbLoadAll();
        hideLoading();
        loadSettings();renderDashboard();renderSidebar();loadCounts();
        startTimerCheck();startLiveTimers();setInterval(updateDate,60000);
        setTimeout(()=>{const db=document.getElementById('mainDashboard');db.style.transition='opacity 0.2s ease';db.style.opacity='1';},30);
        document.getElementById('importFileInput').addEventListener('change',handleImportFile);
        document.getElementById('documentFileInput').addEventListener('change',handleDocFileInput);
        document.getElementById('documentCameraInput').addEventListener('change',handleDocCamInput);
        setupCtxMenuClose();
    }catch(e){
        hideLoading();
        console.error(e);
        document.body.innerHTML='<div style="padding:20px"><h1>Error</h1><p>'+e.message+'</p></div>';
    }
});


// ============================================================
//  SETTINGS / MODE
// ============================================================
function loadSettings(){curMode=cacheGet('currentMode')||'fileMovement';curType=cacheGet('currentEntryType')||'picture';}
function selectMode(m,t){curMode=m;curType=t;dbSet('currentMode',m);dbSet('currentEntryType',t);renderDashboard();loadCounts();closeSidebar();setTimeout(updateMenuSel,50);}
function updateMenuSel(){
    document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
    let id='';
    if(curMode==='fileMovement')id=curType==='picture'?'menuFilePicture':'menuFileTitle';
    else if(curMode==='office')id=curType==='assignedTask'?'menuAssignedTask':'menuMaterialMovement';
    else if(curMode==='myDocument')id='menuMyDocument';
    const el=document.getElementById(id);if(el)el.classList.add('active');
}
function setupCtxMenuClose(){document.addEventListener('click',e=>{if(!e.target.closest('.context-menu'))hideCtxMenu();});}

// ============================================================
//  DASHBOARD HTML
// ============================================================
function renderDashboard(){
    const d=document.getElementById('mainDashboard');
    if(curMode==='fileMovement')d.innerHTML=fileMovHTML();
    else if(curMode==='office'&&curType==='assignedTask')d.innerHTML=taskHTML();
    else if(curMode==='office'&&curType==='picture')d.innerHTML=matHTML();
    else if(curMode==='myDocument')d.innerHTML=myDocHTML();
    updateDate();
}
function fileMovHTML(){return`<div class="header"><div class="menu-icon" onclick="openSidebar()"><span></span><span></span><span></span></div><div class="header-content"><h1>File Movement</h1><div class="date" id="currentDate"></div></div></div>
<div class="card-wrapper"><div class="card files-out" onclick="openDetailView('filesOut')"><div class="card-content"><h2>Files Out</h2><div class="count" id="filesOutCount">0</div></div><div class="card-icon">üìÑ</div></div></div>
<div class="card-wrapper"><div class="card overdue" onclick="openDetailView('overdueFiles')"><div class="card-content"><h2>Overdue Files</h2><div class="count" id="overdueCount">0</div></div><div class="card-icon">‚ö†Ô∏è</div></div></div>
<div class="card-wrapper"><div class="card returned" onclick="openDetailView('returnedFiles')"><div class="card-content"><h2>Returned Files</h2><div class="count" id="returnedCount">0</div></div><div class="card-icon">‚úÖ</div></div></div>
<button class="new-entry-btn" onclick="handleNewEntry()">+ New File Entry</button>`;}
function taskHTML(){return`<div class="header"><div class="menu-icon" onclick="openSidebar()"><span></span><span></span><span></span></div><div class="header-content"><h1>Assigned Task</h1><div class="date" id="currentDate"></div></div></div>
<div class="card-wrapper"><div class="card pending" onclick="openDetailView('pendingTasks')"><div class="card-content"><h2>Pending Tasks</h2><div class="count" id="pendingCount">0</div></div><div class="card-icon">‚è≥</div></div></div>
<div class="card-wrapper"><div class="card overdue" onclick="openDetailView('overdueTasks')"><div class="card-content"><h2>Overdue Tasks</h2><div class="count" id="overdueTaskCount">0</div></div><div class="card-icon">‚ö†Ô∏è</div></div></div>
<div class="card-wrapper"><div class="card completed" onclick="openDetailView('completedTasks')"><div class="card-content"><h2>Completed Tasks</h2><div class="count" id="completedCount">0</div></div><div class="card-icon">‚úì</div></div></div>
<button class="new-entry-btn" onclick="handleNewEntry()">+ New Task Entry</button>`;}
function matHTML(){return`<div class="header"><div class="menu-icon" onclick="openSidebar()"><span></span><span></span><span></span></div><div class="header-content"><h1>Office Materials</h1><div class="date" id="currentDate"></div></div></div>
<div class="card-wrapper"><div class="card materials-out" onclick="openDetailView('materialsOut')"><div class="card-content"><h2>Materials Out</h2><div class="count" id="materialsOutCount">0</div></div><div class="card-icon">üì¶</div></div></div>
<div class="card-wrapper"><div class="card materials-overdue" onclick="openDetailView('materialsOverdue')"><div class="card-content"><h2>Overdue Materials</h2><div class="count" id="materialsOverdueCount">0</div></div><div class="card-icon">‚ö†Ô∏è</div></div></div>
<div class="card-wrapper"><div class="card materials-returned" onclick="openDetailView('materialsReturned')"><div class="card-content"><h2>Returned Materials</h2><div class="count" id="materialsReturnedCount">0</div></div><div class="card-icon">‚úÖ</div></div></div>
<button class="new-entry-btn" onclick="handleNewEntry()">+ New Material Entry</button>`;}
function myDocHTML(){return`<div class="header"><div class="menu-icon" onclick="openSidebar()"><span></span><span></span><span></span></div><div class="header-content"><h1>My Document</h1><div class="date" id="currentDate"></div></div></div>
<div class="card-wrapper"><div class="card english-file" onclick="openEnglishFile()"><div class="card-content"><h2>English File</h2><div class="count" id="englishFileCount">0</div></div><div class="card-icon">üìò</div></div></div>
<div class="card-wrapper"><div class="card bail-bonds" onclick="openBailBonds()"><div class="card-content"><h2>Bail Bonds</h2><div class="count" id="bailBondsCount">0</div></div><div class="card-icon">‚öñÔ∏è</div></div></div>
<div class="card-wrapper"><div class="card record" onclick="openRecord()"><div class="card-content"><h2>Record</h2><div class="count" id="recordCount">0</div></div><div class="card-icon">üìÅ</div></div></div>`;}
function updateDate(){const el=document.getElementById('currentDate');if(el)el.textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}

// ============================================================
//  SIDEBAR
// ============================================================
function renderSidebar(){
    document.getElementById('sidebarSections').innerHTML=`
    <div class="sb-section">
        <div class="sb-section-header"><span class="sb-section-title">File Movement</span></div>
        <button class="menu-item" id="menuFilePicture" onclick="selectMode('fileMovement','picture')">üì∑ Picture Entry</button>
        <button class="menu-item" id="menuFileTitle" onclick="selectMode('fileMovement','title')">üìù Title Entry</button>
    </div>
    <div class="sb-section">
        <div class="sb-section-header"><span class="sb-section-title">Office</span></div>
        <button class="menu-item" id="menuAssignedTask" onclick="selectMode('office','assignedTask')">üìã Assigned Task</button>
        <button class="menu-item" id="menuMaterialMovement" onclick="selectMode('office','picture')">üì¶ Material Movement</button>
    </div>
    <div class="sb-section">
        <div class="sb-section-header"><span class="sb-section-title">Documents</span></div>
        <button class="menu-item" id="menuMyDocument" onclick="selectMode('myDocument','view')">üìÅ My Documents</button>
        <button class="menu-item" id="menuProcessing" onclick="openProcessing()">‚öñÔ∏è Processing (ÿßÿ¨ÿ±ÿßÿ¶€å)</button>
    </div>
    <div class="sb-section">
        <div class="sb-section-header"><span class="sb-section-title">Settings</span></div>
        <button class="menu-item" onclick="importData()">üì• Import Data</button>
        <button class="menu-item" onclick="exportData()">üì§ Export Data</button>
    </div>`;
    updateMenuSel();
}

function openSidebar(){
    document.getElementById('sidebarMenu').classList.add('active');
    document.getElementById('sidebarOverlay').classList.add('active');
}
function closeSidebar(){
    document.getElementById('sidebarMenu').classList.remove('active');
    document.getElementById('sidebarOverlay').classList.remove('active');
}

// ============================================================
//  FORM
// ============================================================
function pageShow(el){el.classList.add('active');}
function pageHide(el,onDone){
    el.style.transition='opacity 0.18s ease';
    el.style.opacity='0';
    setTimeout(()=>{
        el.classList.remove('active');
        el.style.opacity='';el.style.transition='';
        if(onDone)onDone();
    },180);
}
function showDashboard(){
    const db=document.getElementById('mainDashboard');
    db.style.opacity='0';
    db.style.display='block';
    requestAnimationFrame(()=>{
        db.style.transition='opacity 0.18s ease';
        db.style.opacity='1';
        setTimeout(()=>{db.style.transition='';},200);
    });
}
function hideDashboard(){
    const db=document.getElementById('mainDashboard');
    db.style.opacity='0';
    setTimeout(()=>{db.style.display='none';db.style.opacity='';},180);
}
function handleNewEntry(){
    renderForm();pushNav('form',{});
    hideDashboard();
    setTimeout(()=>pageShow(document.getElementById('formContainer')),60);
}
function renderForm(){
    const c=document.getElementById('formContainer');
    const isTask=curMode==='office'&&curType==='assignedTask';
    const isMat=curMode==='office'&&curType==='picture';
    const isPic=curType==='picture';
    const title=isTask?'Assigned Task':isMat?'Office Materials':'File Movement';
    const fields=isTask?taskFields():isMat?matFields():isPic?picFields():titleFields();
    c.innerHTML=`<div class="header"><button class="back-btn" onclick="cancelForm()">‚Üê</button><div class="header-content"><h1>${title}</h1></div></div>
<div class="form-section">${fields}</div>
<div class="form-actions"><button class="cancel-btn" onclick="cancelForm()">Cancel</button><button class="save-btn" onclick="saveEntry()">Save Entry üíæ</button></div>`;
    setupCamListener(isPic||isMat);
}
function taskFields(){return`<div class="input-field"><label>Task Type <span class="required">*</span></label><select id="taskType"><option value="">Select</option><option value="document">Document Preparation</option><option value="meeting">Meeting</option><option value="research">Research</option><option value="filing">Filing</option><option value="others">Others</option></select></div>
<div class="input-field"><label>Task Details <span class="required">*</span></label><textarea id="taskDetails" placeholder="Enter task details"></textarea></div>
<div class="input-field"><label>Assigned To <span class="required">*</span></label><select id="assignedTo" onchange="toggleFields()"><option value="">Select</option><option value="staff">Staff</option><option value="official">Official</option><option value="advocate">Advocate</option><option value="clerk_advocate">Clerk Advocate</option><option value="others">Others</option></select></div>
<div class="input-field" id="nameField" style="display:none;"><label>Name <span class="required">*</span></label><input type="text" id="name"></div>
<div class="input-field" id="mobileField" style="display:none;"><label>Mobile <span class="required">*</span></label><input type="tel" id="mobile" placeholder="03XXXXXXXXX"></div>
<div class="input-field"><label>Duration <span class="required">*</span></label><div class="duration-control"><button type="button" class="duration-btn" onclick="chDur(-1)">‚àí</button><span class="duration-value" id="durVal">${DURATIONS[durIdx]}</span><button type="button" class="duration-btn" onclick="chDur(1)">+</button></div><div id="customDurDiv" style="display:none;margin-top:10px;"><input type="date" id="customDurDate" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-size:15px;"></div></div>`;}
function matFields(){return`<div class="capture-box" id="captureBox" onclick="document.getElementById('camInput').click()"><div class="camera-icon" id="camIcon">üì∑</div><div class="capture-text" id="camText">Tap to Capture (Optional)</div><img id="capturedImg" style="display:none;max-width:80px;max-height:80px;border-radius:8px;"></div>
<input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
<div class="input-field"><label>Material Details</label><textarea id="materialDetails" placeholder="Enter material details"></textarea></div>
<div class="input-field"><label>Taken By <span class="required">*</span></label><select id="takenBy" onchange="toggleFields()"><option value="">Select</option><option value="staff">Staff</option><option value="official">Official</option><option value="advocate">Advocate</option><option value="clerk_advocate">Clerk Advocate</option><option value="others">Others</option></select></div>
<div class="input-field" id="nameField" style="display:none;"><label>Name <span class="required">*</span></label><input type="text" id="name"></div>
<div class="input-field" id="mobileField" style="display:none;"><label>Mobile <span class="required">*</span></label><input type="tel" id="mobile" placeholder="03XXXXXXXXX"></div>
<div class="input-field"><label>Duration <span class="required">*</span></label><div class="duration-control"><button type="button" class="duration-btn" onclick="chDur(-1)">‚àí</button><span class="duration-value" id="durVal">${DURATIONS[durIdx]}</span><button type="button" class="duration-btn" onclick="chDur(1)">+</button></div><div id="customDurDiv" style="display:none;margin-top:10px;"><input type="date" id="customDurDate" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-size:15px;"></div></div>`;}
function picFields(){return`<div class="capture-box" id="captureBox" onclick="document.getElementById('camInput').click()"><div class="camera-icon" id="camIcon">üì∑</div><div class="capture-text" id="camText">Tap to Capture</div><img id="capturedImg" style="display:none;max-width:80px;max-height:80px;border-radius:8px;"></div>
<input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
<div class="input-field"><label>Hearing Date <span class="required">*</span></label><input type="date" id="dateField"></div>
<div class="input-field"><label>Taken By <span class="required">*</span></label><select id="takenBy" onchange="toggleFields()"><option value="">Select</option><option value="advocate">Advocate</option><option value="munshi">Munshi</option><option value="staff">Staff</option><option value="others">Others</option></select></div>
<div class="input-field" id="nameField" style="display:none;"><label>Name <span class="required">*</span></label><input type="text" id="name"></div>
<div class="input-field" id="mobileField" style="display:none;"><label>Mobile <span class="required">*</span></label><input type="tel" id="mobile" placeholder="03XXXXXXXXX"></div>
<div class="input-field"><label>Duration <span class="required">*</span></label><div class="duration-control"><button type="button" class="duration-btn" onclick="chDur(-1)">‚àí</button><span class="duration-value" id="durVal">${DURATIONS[durIdx]}</span><button type="button" class="duration-btn" onclick="chDur(1)">+</button></div><div id="customDurDiv" style="display:none;margin-top:10px;"><input type="date" id="customDurDate" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-size:15px;"></div></div>`;}
function titleFields(){return`<div class="input-field"><label>Case Title <span class="required">*</span></label><input type="text" id="title" placeholder="Enter case title"></div>
<div class="input-field"><label>Case Nature <span class="required">*</span></label><select id="nature"><option value="">Select</option><option value="civil">Civil</option><option value="criminal">Criminal</option><option value="execution">Execution</option><option value="miscellaneous">Miscellaneous</option><option value="others">Others</option></select></div>
<div class="input-field"><label>Hearing Date <span class="required">*</span></label><input type="date" id="dateField"></div>
<div class="input-field"><label>Taken By <span class="required">*</span></label><select id="takenBy" onchange="toggleFields()"><option value="">Select</option><option value="advocate">Advocate</option><option value="munshi">Munshi</option><option value="staff">Staff</option><option value="others">Others</option></select></div>
<div class="input-field" id="nameField" style="display:none;"><label>Name <span class="required">*</span></label><input type="text" id="name"></div>
<div class="input-field" id="mobileField" style="display:none;"><label>Mobile <span class="required">*</span></label><input type="tel" id="mobile" placeholder="03XXXXXXXXX"></div>
<div class="input-field"><label>Duration <span class="required">*</span></label><div class="duration-control"><button type="button" class="duration-btn" onclick="chDur(-1)">‚àí</button><span class="duration-value" id="durVal">${DURATIONS[durIdx]}</span><button type="button" class="duration-btn" onclick="chDur(1)">+</button></div><div id="customDurDiv" style="display:none;margin-top:10px;"><input type="date" id="customDurDate" style="width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-size:15px;"></div></div>`;}
function setupCamListener(has){
    if(!has)return;
    setTimeout(()=>{
        const cam=document.getElementById('camInput');
        if(!cam)return;
        cam.onchange=async function(e){
            const f=e.target.files[0];if(!f)return;
            const c=await fileToCompressed(f);
            const img=document.getElementById('capturedImg');
            if(img&&c){img.src=c;img.style.display='block';const ic=document.getElementById('camIcon'),tx=document.getElementById('camText');if(ic)ic.style.display='none';if(tx)tx.textContent='‚úì Captured';}
        };
    },100);
}
function toggleFields(){const s=document.getElementById('assignedTo')||document.getElementById('takenBy');const v=s?s.value:'';const nf=document.getElementById('nameField'),mf=document.getElementById('mobileField');if(nf)nf.style.display=v?'block':'none';if(mf)mf.style.display=v?'block':'none';}
function chDur(d){
    const n=durIdx+d;if(n>=0&&n<DURATIONS.length){durIdx=n;const el=document.getElementById('durVal');if(el)el.textContent=DURATIONS[durIdx];}
    // Show/hide custom date input
    const customDiv=document.getElementById('customDurDiv');
    if(customDiv)customDiv.style.display=(DURATIONS[durIdx]==='Enter Date')?'block':'none';
}
function durMins(d){return({'5 Mins':5,'15 Mins':15,'30 Mins':30,'1 Hour':60,'2 Hours':120,'3 Hours':180,'1 Day':1440,'2 Days':2880})[d]||60;}
function getDurExpiry(){
    // Returns expiresAt ISO string based on current duration selection
    if(DURATIONS[durIdx]==='Enter Date'){
        const dateEl=document.getElementById('customDurDate');
        if(!dateEl||!dateEl.value){alert('Please select a date!');return null;}
        // Set time to end of selected day
        const d=new Date(dateEl.value);d.setHours(23,59,59,999);
        return d.toISOString();
    }
    return new Date(Date.now()+durMins(DURATIONS[durIdx])*60000).toISOString();
}

// ============================================================
//  SAVE ENTRY
// ============================================================
async function saveEntry(){
    const isTask=curMode==='office'&&curType==='assignedTask';
    const isMat=curMode==='office'&&curType==='picture';
    const isPic=curType==='picture';
    if(isTask)await saveTask();
    else if(isMat)await saveMat();
    else await saveFileMov(isPic);
}
function valMob(m){return /^03[0-9]{9}$/.test(m);}
function gv(id){const el=document.getElementById(id);return el?(el.value||'').trim():'';}

async function saveTask(){
    const tt=gv('taskType'),td=gv('taskDetails'),at=gv('assignedTo'),nm=gv('name'),mb=gv('mobile');
    if(!tt||!td||!at||!nm||!mb){alert('Please fill all required fields!');return;}
    if(!valMob(mb)){alert('Mobile must be 11 digits starting with 03!');return;}
    showLoading('Saving task...');
    const expAt=getDurExpiry();if(!expAt)return;
    const entry={id:Date.now(),taskType:tt,taskDetails:td,assignedTo:at,name:nm,mobile:mb,
        duration:DURATIONS[durIdx],createdAt:new Date().toISOString(),
        expiresAt:expAt,mode:'assignedTask'};
    try{const arr=JSON.parse(cacheGet('pendingTasks')||'[]');arr.push(entry);await dbSet('pendingTasks',JSON.stringify(arr));cancelForm();loadCounts();}
    catch(e){alert('Save failed: '+e.message);}
    hideLoading();
}
async function saveMat(){
    const img=document.getElementById('capturedImg');
    const hasPic=img&&img.src&&img.style.display!=='none';
    const md=gv('materialDetails');
    if(!hasPic&&!md){alert('Please provide a picture or material details!');return;}
    const tb=gv('takenBy'),nm=gv('name'),mb=gv('mobile');
    if(!tb||!nm||!mb){alert('Please fill all required fields!');return;}
    if(!valMob(mb)){alert('Mobile must be 11 digits starting with 03!');return;}
    showLoading('Saving material...');
    const expAt=getDurExpiry();if(!expAt)return;
    const entry={id:Date.now(),image:hasPic?img.src:null,materialDetails:md,takenBy:tb,name:nm,mobile:mb,
        duration:DURATIONS[durIdx],createdAt:new Date().toISOString(),
        expiresAt:expAt,mode:'officeMaterial'};
    try{const arr=JSON.parse(cacheGet('materialsOut')||'[]');arr.push(entry);await dbSet('materialsOut',JSON.stringify(arr));cancelForm();loadCounts();}
    catch(e){alert('Save failed: '+e.message);}
    hideLoading();
}
async function saveFileMov(isPic){
    let title='',nature='',image=null;
    if(isPic){const img=document.getElementById('capturedImg');if(!img||!img.src||img.style.display==='none'){alert('Please capture an image!');return;}image=img.src;title='Image Captured';nature='N/A';}
    else{title=gv('title');nature=gv('nature');if(!title||!nature){alert('Please fill all required fields!');return;}}
    const df=gv('dateField'),tb=gv('takenBy'),nm=gv('name'),mb=gv('mobile');
    if(!df||!tb||!nm||!mb){alert('Please fill all required fields!');return;}
    if(!valMob(mb)){alert('Mobile must be 11 digits starting with 03!');return;}
    showLoading('Saving entry...');
    const expAt=getDurExpiry();if(!expAt)return;
    const entry={id:Date.now(),title,nature,dateField:df,takenBy:tb,name:nm,mobile:mb,
        duration:DURATIONS[durIdx],createdAt:new Date().toISOString(),
        expiresAt:expAt,image,mode:'fileMovement'};
    try{const arr=JSON.parse(cacheGet('filesOut')||'[]');arr.push(entry);await dbSet('filesOut',JSON.stringify(arr));cancelForm();loadCounts();}
    catch(e){alert('Save failed: '+e.message);}
    hideLoading();
}
function cancelForm(){navStack.pop();pageHide(document.getElementById('formContainer'),showDashboard);}

// ============================================================
//  COUNTS
// ============================================================
function loadCounts(){
    if(curMode==='fileMovement'){sst('filesOutCount',glen('filesOut'));sst('overdueCount',glen('overdueFiles'));sst('returnedCount',glen('returnedFiles'));}
    else if(curMode==='office'&&curType==='assignedTask'){sst('pendingCount',glen('pendingTasks'));sst('overdueTaskCount',glen('overdueTasks'));sst('completedCount',glen('completedTasks'));}
    else if(curMode==='office'&&curType==='picture'){sst('materialsOutCount',glen('materialsOut'));sst('materialsOverdueCount',glen('materialsOverdue'));sst('materialsReturnedCount',glen('materialsReturned'));}
    else if(curMode==='myDocument'){
        const ef=JSON.parse(cacheGet('englishFile_folders')||'[]');let et=0;ef.forEach(f=>et+=(f.documents||[]).length);sst('englishFileCount',et);
        sst('bailBondsCount',glen('bailBonds'));
        const rf=JSON.parse(cacheGet('record_folders')||'[]');let rt=0;rf.forEach(f=>rt+=(f.cases||[]).length);sst('recordCount',rt);
    }
}
function sst(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function glen(key){return JSON.parse(cacheGet(key)||'[]').length;}

// ============================================================
//  UTILS
// ============================================================
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function fmtDate(d){if(!d)return'N/A';const dt=new Date(d);if(isNaN(dt))return d;return`${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`;}
function retStatus(r,e){
    const ret=new Date(r),exp=new Date(e);
    if(ret<=exp)return '<span style="color:#16a34a;font-weight:600;">‚úì On Time</span>';
    const diff=ret-exp;
    const dy=Math.floor(diff/86400000),hr=Math.floor((diff%86400000)/3600000),mn=Math.floor((diff%3600000)/60000);
    let late='';
    if(dy>0)late=dy+'d '+(hr>0?hr+'h ':'')+(mn>0?mn+'m':'');
    else if(hr>0)late=hr+'h '+(mn>0?mn+'m':'');
    else late=mn+'m';
    return '<span style="color:#dc2626;font-weight:600;">‚ö† '+late.trim()+' Late</span>';
}
function timeLeft(ex){
    const d=new Date(ex)-new Date();
    if(d<=0)return'<span style="color:#dc2626;font-weight:700;">OVERDUE</span>';
    const dy=Math.floor(d/86400000);
    const hr=Math.floor((d%86400000)/3600000);
    const mn=Math.floor((d%3600000)/60000);
    // 24 ghante se zyada bacha: days + hours dikhao
    if(dy>=1){return`<span style="color:#d97706;font-weight:700;">${dy}d ${hr}h remaining</span>`;}
    // Last 24 hours: hours + minutes (no seconds)
    if(hr>0)return`<span style="color:#d97706;font-weight:700;">${hr}h ${mn}m remaining</span>`;
    if(mn>0)return`<span style="color:#dc2626;font-weight:700;">${mn}m remaining</span>`;
    return'<span style="color:#dc2626;font-weight:700;">Less than a minute</span>';
}

// ============================================================
//  TIMERS
// ============================================================
function startLiveTimers(){
    if(liveTimerIv)clearInterval(liveTimerIv);
    // Har 60 seconds update (minutes count, seconds nahi)
    liveTimerIv=setInterval(()=>{
        // Sirf tab update karo jab detail view screen par ho
        const dv=document.getElementById('detailView');
        if(!dv||!dv.classList.contains('active'))return;
        ['filesOut','overdueFiles','pendingTasks','overdueTasks','materialsOut','materialsOverdue'].forEach(key=>{
            JSON.parse(cacheGet(key)||'[]').forEach(item=>{
                const el=document.getElementById('timer-'+item.id);
                if(el)el.innerHTML='<strong>Time Remaining:</strong> '+timeLeft(item.expiresAt);
            });
        });
    },60000);
}
function startTimerCheck(){
    if(overdueIv)clearInterval(overdueIv);
    overdueIv=setInterval(()=>{checkOverdue('filesOut','overdueFiles');checkOverdue('pendingTasks','overdueTasks');checkOverdue('materialsOut','materialsOverdue');},30000);
}
async function checkOverdue(sk,ok){
    const items=JSON.parse(cacheGet(sk)||'[]'),overdues=JSON.parse(cacheGet(ok)||'[]'),now=new Date(),still=[],newly=[];
    items.forEach(i=>{if(now>new Date(i.expiresAt)){overdues.push(i);newly.push(i);}else still.push(i);});
    if(newly.length){await dbSet(sk,JSON.stringify(still));await dbSet(ok,JSON.stringify(overdues));loadCounts();}
}

// ============================================================
//  DETAIL VIEW
// ============================================================
function openDetailView(type){pushNav('detailView',{type});_detailInternal(type);}
function _detailInternal(type){
    const TITLES={filesOut:'Files Out',overdueFiles:'Overdue Files',returnedFiles:'Returned Files',pendingTasks:'Pending Tasks',overdueTasks:'Overdue Tasks',completedTasks:'Completed Tasks',materialsOut:'Materials Out',materialsOverdue:'Overdue Materials',materialsReturned:'Returned Materials'};
    let files=JSON.parse(cacheGet(type)||'[]');files.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
    let html=`<div class="header"><button class="back-btn" onclick="closeDetailView()">‚Üê</button><div class="header-content"><h1>${TITLES[type]}</h1></div></div>`;
    if(!files.length)html+='<div class="empty-state"><div class="empty-state-icon">üìÇ</div><p>No entries found</p></div>';
    else files.forEach(f=>html+=renderFileItem(f,type));
    const dv=document.getElementById('detailView');dv.innerHTML=html;hideDashboard();setTimeout(()=>pageShow(dv),60);
}
function isDayOrDateDur(dur){
    // Minutes/Hours = short duration; Days or custom date = long duration (show taken/returned dates)
    return !['5 Mins','15 Mins','30 Mins','1 Hour','2 Hours','3 Hours'].includes(dur);
}
function renderFileItem(file,type){
    const isRet=['returnedFiles','completedTasks','materialsReturned'].includes(type);
    const isOvr=['overdueFiles','overdueTasks','materialsOverdue'].includes(type);
    const fid=file.id,en=(file.name||'').replace(/'/g,"\'").replace(/"/g,'&quot;'),et=(file.title||file.taskType||'Entry').replace(/'/g,"\'").replace(/"/g,'&quot;');
    const useDateView=isDayOrDateDur(file.duration);

    // BANNER: picture or title/taskType
    let banner='';
    if(file.image)banner=`<div class="file-banner picture-banner" onclick="showImgPrev(this)" data-src="${file.image.replace(/"/g,'&quot;')}">üñº View Picture</div>`;
    else if(file.title&&file.title!=='Image Captured')banner=`<div class="file-banner">${esc(file.title)}</div>`;
    else if(file.taskType)banner=`<div class="file-banner">${esc(file.taskType)}</div>`;

    // FILE INFO BLOCK: hearing/decision date + nature centered, then divider line
    let fileInfoLine='';
    if(file.mode==='fileMovement'&&file.dateField){
        const isFuture=new Date(file.dateField)>=new Date(new Date().toDateString());
        const label=isFuture?'Hearing Date':'Decision Date';
        const naturePart=file.nature&&file.nature!=='N/A'?`<span style="margin-left:12px;color:var(--text-secondary);font-weight:500;">| ${esc(file.nature)}</span>`:'';
        fileInfoLine=`<div style="text-align:center;padding:6px 12px 8px;border-bottom:1px solid var(--border-color);margin-bottom:6px;"><span style="font-weight:600;font-size:14px;color:var(--text-primary);">${label}: ${fmtDate(file.dateField)}</span>${naturePart}</div>`;
    }

    // TAKEN LINE: "Taken Date: XX for 5 Mins" OR "Taken Date: XX / Returned Date: XX"
    let info='';
    if(file.mode==='assignedTask'){
        const rs=isRet?retStatus(file.returnedAt||file.completedAt,file.expiresAt):'';
        const takenLine=useDateView
            ?`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)}</p><p><strong>Due Complete Date:</strong> ${fmtDate(file.expiresAt)}</p>`
            :`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)} <span style="color:var(--text-secondary);font-weight:normal;">for ${esc(file.duration||'')}</span></p>`;
        info=`<p><strong>Task Details:</strong> ${esc(file.taskDetails||'')}</p><p><strong>Assigned To:</strong> ${esc(file.name||'')} (${esc(file.assignedTo||'')})</p>${takenLine}${!isRet?`<p id="timer-${fid}"><strong>Time Remaining:</strong> ${timeLeft(file.expiresAt)}</p>`:''}${isRet?`<p><strong>Completed:</strong> ${fmtDate(file.returnedAt||file.completedAt)} ${rs}</p>`:''}`;
    }else if(file.mode==='officeMaterial'){
        const rs=isRet?retStatus(file.returnedAt,file.expiresAt):'';
        const takenLine=useDateView
            ?`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)}</p><p><strong>Due Return Date:</strong> ${fmtDate(file.expiresAt)}</p>`
            :`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)} <span style="color:var(--text-secondary);font-weight:normal;">for ${esc(file.duration||'')}</span></p>`;
        info=`${file.materialDetails?`<p><strong>Details:</strong> ${esc(file.materialDetails)}</p>`:''}<p><strong>Taken By:</strong> ${esc(file.name||'')}</p>${takenLine}${!isRet?`<p id="timer-${fid}"><strong>Time Remaining:</strong> ${timeLeft(file.expiresAt)}</p>`:''}${isRet?`<p><strong>Returned:</strong> ${fmtDate(file.returnedAt)} ${rs}</p>`:''}`;
    }else{
        // fileMovement
        const rs=isRet?retStatus(file.returnedAt,file.expiresAt):'';
        const takenLine=useDateView
            ?`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)}</p><p><strong>Due Return Date:</strong> ${fmtDate(file.expiresAt)}</p>`
            :`<p><strong>Taken Date:</strong> ${fmtDate(file.createdAt)} <span style="color:var(--text-secondary);font-weight:normal;">for ${esc(file.duration||'')}</span></p>`;
        info=`<p><strong>Taken By:</strong> ${esc(file.name||'')}</p>${takenLine}${file.nature&&file.nature!=='N/A'&&!file.dateField?`<p><strong>Nature:</strong> ${esc(file.nature)}</p>`:''}${!isRet?`<p id="timer-${fid}"><strong>Time Remaining:</strong> ${timeLeft(file.expiresAt)}</p>`:''}${isRet?`<p><strong>Returned:</strong> ${fmtDate(file.returnedAt)} ${rs}</p>`:''}`;
    }

    const warn=(!isRet&&isOvr)?`<div class="overdue-warning">‚ö† Take Action against ${esc(file.name||'')}</div>`:'';
    const rl=file.mode==='assignedTask'?'Complete':'Receive';
    return `<div class="file-item">${banner}${fileInfoLine}<div class="file-content"><div class="file-info">${info}</div>${warn}<div class="file-actions"><button class="action-btn call-btn" onclick="makeCall('${esc(file.mobile||'')}')">üìû Call</button>${!isRet?`<button class="action-btn receive-btn" onclick="confirmReceive(${fid},'${type}','${et}','${en}')">‚úì ${rl}</button>`:''}${isRet?`<button class="action-btn delete-btn" onclick="confirmDelete(${fid},'${type}','${et}')">üóë Delete</button>`:''}</div></div></div>`;
}

function showImgPrev(elOrSrc){const src=typeof elOrSrc==='string'?elOrSrc:elOrSrc.getAttribute('data-src');document.getElementById('modalImage').src=src;document.getElementById('imageModal').classList.add('show');}
function closeImageModal(){document.getElementById('imageModal').classList.remove('show');}
function closeDetailView(){navStack=[];pageHide(document.getElementById('detailView'),showDashboard);}
function closeDetail(){closeDetailView();}
function makeCall(m){if(m)window.location.href='tel:'+m;}

// ============================================================
//  CONFIRM / RECEIVE / DELETE
// ============================================================
function confirmReceive(id,type,title,name){const isTask=type.includes('Task');showConfirmPopup(`Confirm ${isTask?'Completion':'Return'}`,`Has "${title}" been ${isTask?'completed':'returned'} by ${name}?`,()=>doReceive(id,type));}
async function doReceive(id,type){
    const MAP={filesOut:{f:'filesOut',t:'returnedFiles'},overdueFiles:{f:'overdueFiles',t:'returnedFiles'},pendingTasks:{f:'pendingTasks',t:'completedTasks'},overdueTasks:{f:'overdueTasks',t:'completedTasks'},materialsOut:{f:'materialsOut',t:'materialsReturned'},materialsOverdue:{f:'materialsOverdue',t:'materialsReturned'}};
    const k=MAP[type];if(!k)return;
    const arr=JSON.parse(cacheGet(k.f)||'[]'),idx=arr.findIndex(f=>f.id===id);if(idx===-1)return;
    const file=arr[idx],now=new Date();arr.splice(idx,1);
    await dbSet(k.f,JSON.stringify(arr));
    const ret=JSON.parse(cacheGet(k.t)||'[]');ret.push({...file,returnedAt:now.toISOString(),completedAt:now.toISOString(),returnedLate:now>new Date(file.expiresAt)});
    await dbSet(k.t,JSON.stringify(ret));openDetailView(type);loadCounts();
}
function confirmDelete(id,type,title){showConfirmPopup('Delete Entry',`Enter password to delete "${title}"`,()=>doDelete(id,type),true);}
async function doDelete(id,type){
    if(!['returnedFiles','completedTasks','materialsReturned'].includes(type))return;
    const arr=JSON.parse(cacheGet(type)||'[]');await dbSet(type,JSON.stringify(arr.filter(f=>f.id!==id)));openDetailView(type);loadCounts();
}

// ============================================================
//  POPUPS
// ============================================================
function showConfirmPopup(title,msg,onOk,needPw=false){
    document.getElementById('popupTitle').textContent=title;document.getElementById('popupMessage').textContent=msg;
    const pw=document.getElementById('passwordInput');pw.style.display=needPw?'block':'none';pw.value='';
    document.getElementById('confirmPopup').classList.add('active');
    if(needPw)setTimeout(()=>pw.focus(),200);
    document.getElementById('confirmBtn').onclick=function(){
        if(needPw&&pw.value!=='0000'){alert('Incorrect password!');pw.value='';pw.focus();return;}
        closeConfirmPopup();if(onOk)onOk();
    };
}
function closeConfirmPopup(){document.getElementById('confirmPopup').classList.remove('active');document.getElementById('passwordInput').value='';}
function closePopup(){const p=document.getElementById('entryPopup');p.classList.remove('active');p.style.display='';p.innerHTML='';p._imgs=null;p._files=null;}
function showEntryPopup(html){const p=document.getElementById('entryPopup');p.innerHTML=`<div class="popup-content" style="max-width:480px;">${html}</div>`;p.style.display='flex';}

// ============================================================
//  LONG PRESS
// ============================================================
function setupLP(el,data){
    el.addEventListener('touchstart',e=>{lpData=data;lpTimer=setTimeout(()=>showCtxMenu(e.touches[0].clientX,e.touches[0].clientY),LP_DUR);},{passive:true});
    el.addEventListener('touchend',()=>clearTimeout(lpTimer));
    el.addEventListener('touchmove',()=>clearTimeout(lpTimer));
    el.addEventListener('contextmenu',e=>{e.preventDefault();lpData=data;showCtxMenu(e.clientX,e.clientY);});
}
function showCtxMenu(x,y){const m=document.getElementById('contextMenu');m.style.left=Math.min(x,window.innerWidth-175)+'px';m.style.top=Math.min(y,window.innerHeight-160)+'px';m.classList.add('active');}
function hideCtxMenu(){document.getElementById('contextMenu').classList.remove('active');}
function handleContextAction(a){
    hideCtxMenu();if(!lpData)return;
    const{type,category,folderIndex,docIndex,index}=lpData;
    if(a==='edit'){if(type==='folder')editFolder(category,folderIndex);else if(type==='document')editDocument(category,folderIndex,docIndex);else if(type==='recordCase')editRecordCase(folderIndex,index);}
    else if(a==='delete'){if(type==='folder')deleteFolder(category,folderIndex);else if(type==='document')deleteDocument(category,folderIndex,docIndex);else if(type==='bailBond')deleteBailBond(index);else if(type==='recordCase')deleteRecordCase(folderIndex,index);}
    else if(a==='share'){if(type==='document')shareDocument(category,folderIndex,docIndex);else if(type==='bailBond')shareBailBond(index);else if(type==='recordCase')shareRecordCase(folderIndex,index);}
}
function pwConfirm(msg){const pw=prompt('Enter password to delete:');if(pw!=='0000'){alert('Incorrect password!');return false;}return confirm(msg);}

// ============================================================
//  ENGLISH FILE
// ============================================================
function openEnglishFile(fromBack){
    if(!fromBack)pushNav('englishFile',{});
    const folders=JSON.parse(cacheGet('englishFile_folders')||'[]');
    let html=`<div class="detail-header"><button class="back-btn" onclick="closeDetail()">‚Üê</button><h2>English File</h2></div>`;
    folders.forEach((f,i)=>html+=`<div class="folder-card" data-idx="${i}" onclick="openEnglishFolder(${i})"><div class="folder-icon">üìÅ</div><div class="folder-info"><div class="folder-name">${esc(f.name)}</div><div class="folder-count">${(f.documents||[]).length} document(s)</div></div><div class="folder-arrow">‚Ä∫</div></div>`);
    if(folders.length<10)html+=`<button class="add-folder-btn" onclick="createEngFolder()">+ Add Folder</button>`;
    if(!folders.length)html+=`<div class="empty-state"><div class="empty-state-icon">üìÅ</div><p>No folders yet</p></div>`;
    html+=`<p class="long-press-hint">Long press on folder for options</p>`;
    const dv=document.getElementById('detailView');dv.innerHTML=html;hideDashboard();setTimeout(()=>pageShow(dv),60);
    setTimeout(()=>dv.querySelectorAll('.folder-card').forEach(c=>{const i=parseInt(c.getAttribute('data-idx'));setupLP(c,{type:'folder',category:'englishFile',folderIndex:i});}),100);
}
async function createEngFolder(){
    const name=prompt('Enter folder name:');if(!name||!name.trim())return;
    const folders=JSON.parse(cacheGet('englishFile_folders')||'[]');if(folders.length>=10){alert('Maximum 10 folders allowed!');return;}
    folders.push({name:name.trim(),documents:[],createdAt:new Date().toISOString()});
    await dbSet('englishFile_folders',JSON.stringify(folders));openEnglishFile();loadCounts();
}
function openEnglishFolder(fi,fromBack){
    if(!fromBack)pushNav('englishFolder',{folderIndex:fi});
    const folders=JSON.parse(cacheGet('englishFile_folders')||'[]'),folder=folders[fi];
    let html=`<div class="detail-header"><button class="back-btn" onclick="openEnglishFile()">‚Üê</button><h2>${esc(folder.name)}</h2><button onclick="addEngPics(${fi})" style="margin-left:auto;background:#2563eb;color:white;border:none;border-radius:8px;padding:6px 14px;font-size:20px;cursor:pointer;font-weight:700;">+</button></div>
<div class="search-container"><input type="text" class="search-input" id="docSearch" placeholder="üîç Search documents..." oninput="srchEngDocs()"></div>`;
    (folder.documents||[]).forEach((d,di)=>html+=`<div class="document-card" data-idx="${di}" data-n="${esc((d.name||'').toLowerCase())}" onclick="viewEngDoc(${fi},${di})"><div class="doc-icon">üñºÔ∏è</div><div class="doc-info"><div class="doc-name">${esc(d.name)}</div><div class="doc-date">${new Date(d.createdAt).toLocaleDateString()} ‚Ä¢ ${(d.images||(d.data?[d.data]:[])).length} image(s)</div></div></div>`);
    if(!(folder.documents||[]).length)html+=`<div class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No documents yet</p></div>`;
    html+=`<p class="long-press-hint">Click to view ‚Ä¢ Long press for options</p>`;
    const dv=document.getElementById('detailView');dv.innerHTML=html;dv.dataset.cf=fi;
    setTimeout(()=>dv.querySelectorAll('.document-card').forEach(c=>{const di=parseInt(c.getAttribute('data-idx'));setupLP(c,{type:'document',category:'englishFile',folderIndex:fi,docIndex:di});}),100);
}
function srchEngDocs(){const q=(document.getElementById('docSearch').value||'').toLowerCase();document.querySelectorAll('.document-card').forEach(c=>c.style.display=(c.getAttribute('data-n')||'').includes(q)?'flex':'none');}

// ADD MULTIPLE DOCUMENTS - process one by one with title prompt
function addEngPics(fi){
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.multiple=true;
    input.onchange=async e=>{
        const files=Array.from(e.target.files);if(!files.length)return;
        // Show title prompt FIRST, then compress all images after title entered
        showEntryPopup(`
            <h2 style="color:var(--text-primary);margin-bottom:12px;">Document Title</h2>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;text-align:center;">${files.length} image(s) selected ‚Äî sab ek title ke sath save hongi</p>
            <div class="field-group"><label>Document Title <span style="color:red;">*</span></label><input type="text" id="engDocTitle" placeholder="Enter document title" autofocus></div>
            <div class="popup-actions">
                <button class="popup-cancel" onclick="closePopup()">Cancel</button>
                <button class="popup-confirm" onclick="engDocSaveAll(${fi})">Save</button>
            </div>`);
        document.getElementById('entryPopup')._files=files;
    };
    input.click();
}

async function engDocSaveAll(fi){
    const title=(document.getElementById('engDocTitle').value||'').trim();
    if(!title){alert('Please enter a document title!');return;}
    const files=document.getElementById('entryPopup')._files;
    closePopup();
    showLoading(`Compressing 1 of ${files.length} images...`);
    const images=[];
    for(let i=0;i<files.length;i++){
        document.getElementById('loadingText').textContent=`Loading ${i+1} of ${files.length} images...`;
        const c=await fileToOriginal(files[i]);
        if(c)images.push(c);
    }
    if(!images.length){hideLoading();alert('No valid images found!');return;}
    document.getElementById('loadingText').textContent='Saving document...';
    try{
        const folders=JSON.parse(cacheGet('englishFile_folders')||'[]');
        // Save as single document with array of images
        folders[fi].documents.push({name:title,images:images,data:images[0],createdAt:new Date().toISOString()});
        await dbSet('englishFile_folders',JSON.stringify(folders));
        hideLoading();openEnglishFolder(fi);loadCounts();
    }catch(e){hideLoading();alert('Save failed: '+e.message);}
}

function viewEngDoc(fi,di){
    const folders=JSON.parse(cacheGet('englishFile_folders')||'[]'),doc=folders[fi].documents[di];
    const imgs=(doc.images||[doc.data]).filter(Boolean);
    let imgHtml=imgs.map(src=>`<div style="margin-bottom:12px;"><img src="${src}" style="width:100%;border-radius:10px;display:block;cursor:pointer;" onclick="showImgPrev(this)" data-src="${src.replace(/"/g,'&quot;')}"></div>`).join('');
    // Full-screen view so ALL images scroll without any height limit
    const dv=document.getElementById('detailView');
    dv.innerHTML=`<div class="detail-header"><button class="back-btn" onclick="openEnglishFolder(${fi})">‚Üê</button><h2>${esc(doc.name)}</h2></div><p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;padding:0 4px;">${imgs.length} image(s)</p>${imgHtml}`;
    pageShow(dv);
}
async function editFolder(cat,fi){
    const sk=cat+'_folders',folders=JSON.parse(cacheGet(sk)||'[]');
    const n=prompt('Enter new folder name:',folders[fi].name);
    if(n&&n.trim()){folders[fi].name=n.trim();await dbSet(sk,JSON.stringify(folders));if(cat==='englishFile')openEnglishFile();else if(cat==='record')openRecord();loadCounts();}
}
async function deleteFolder(cat,fi){
    if(!pwConfirm('Delete this folder and all its contents?'))return;
    const sk=cat+'_folders',folders=JSON.parse(cacheGet(sk)||'[]');folders.splice(fi,1);
    await dbSet(sk,JSON.stringify(folders));if(cat==='englishFile')openEnglishFile();else if(cat==='record')openRecord();loadCounts();
}
async function editDocument(cat,fi,di){
    const sk=cat+'_folders',folders=JSON.parse(cacheGet(sk)||'[]');
    const n=prompt('Enter new document title:',folders[fi].documents[di].name);
    if(n&&n.trim()){folders[fi].documents[di].name=n.trim();await dbSet(sk,JSON.stringify(folders));if(cat==='englishFile')openEnglishFolder(fi);loadCounts();}
}
async function deleteDocument(cat,fi,di){
    if(!pwConfirm('Delete this document?'))return;
    const sk=cat+'_folders',folders=JSON.parse(cacheGet(sk)||'[]');folders[fi].documents.splice(di,1);
    await dbSet(sk,JSON.stringify(folders));if(cat==='englishFile')openEnglishFolder(fi);loadCounts();
}
async function shareDocument(cat,fi,di){
    const doc=JSON.parse(cacheGet(cat+'_folders')||'[]')[fi].documents[di];
    const imgs=(doc.images||[doc.data]).filter(Boolean);
    if(!navigator.share){alert('Sharing not supported on this browser');return;}
    try{
        // Try sharing as files (images)
        if(imgs.length){
            const files=await Promise.all(imgs.map(async(src,idx)=>{
                const res=await fetch(src);const blob=await res.blob();
                return new File([blob],`${doc.name}_${idx+1}.jpg`,{type:blob.type||'image/jpeg'});
            }));
            if(navigator.canShare&&navigator.canShare({files})){
                await navigator.share({title:doc.name,files});return;
            }
        }
        // Fallback: share text
        await navigator.share({title:doc.name,text:`Document: ${doc.name}\n${imgs.length} image(s)`});
    }catch(e){if(e.name!=='AbortError')alert('Share failed: '+e.message);}
}

// ============================================================
//  BAIL BONDS
// ============================================================
function openBailBonds(fromBack){
    if(!fromBack)pushNav('bailBonds',{});
    const bonds=JSON.parse(cacheGet('bailBonds')||'[]');
    let html=`<div class="detail-header"><button class="back-btn" onclick="closeDetail()">‚Üê</button><h2>Bail Bonds</h2><button onclick="addBailBond()" style="margin-left:auto;background:#2563eb;color:white;border:none;border-radius:8px;padding:6px 14px;font-size:20px;cursor:pointer;font-weight:700;">+</button></div>
<div class="search-container"><input type="text" class="search-input" id="bailSearch" placeholder="üîç Search by FIR, Police Station..." oninput="srchBailBonds()"></div>`;
    bonds.forEach((b,i)=>{const sd=((b.title||'')+' '+(b.firNumber||'')+' '+(b.policeStation||'')).toLowerCase();html+=`<div class="document-card" data-idx="${i}" data-s="${esc(sd)}" onclick="viewBailBond(${i})"><div class="doc-icon">‚öñÔ∏è</div><div class="doc-info"><div class="doc-name">${esc(b.title)}</div><div class="doc-date">FIR: ${esc(b.firNumber)}/${esc(b.firYear)} - ${esc(b.policeStation)}</div><div class="doc-date">${(b.images||[]).length} image(s)</div></div></div>`;});
    if(!bonds.length)html+=`<div class="empty-state"><div class="empty-state-icon">‚öñÔ∏è</div><p>No bail bonds yet</p></div>`;
    html+=`<button class="add-folder-btn" onclick="addBailBond()">+ Add Document</button><p class="long-press-hint">Click to view ‚Ä¢ Long press for options</p>`;
    const dv=document.getElementById('detailView');dv.innerHTML=html;hideDashboard();setTimeout(()=>pageShow(dv),60);
    setTimeout(()=>dv.querySelectorAll('.document-card').forEach(c=>{const i=parseInt(c.getAttribute('data-idx'));setupLP(c,{type:'bailBond',index:i});}),100);
}
function srchBailBonds(){const q=(document.getElementById('bailSearch').value||'').toLowerCase();document.querySelectorAll('.document-card').forEach(c=>c.style.display=(c.getAttribute('data-s')||'').includes(q)?'flex':'none');}
function addBailBond(){
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.multiple=true;
    input.onchange=e=>{
        const files=Array.from(e.target.files);if(!files.length)return;
        showEntryPopup(`<h2 style="color:var(--text-primary);margin-bottom:15px;">Bail Bond Details</h2>
<div class="field-group"><label>FIR Number <span style="color:red;">*</span></label><input type="text" id="bFir"></div>
<div class="field-group"><label>FIR Year <span style="color:red;">*</span></label><input type="text" id="bYear" value="2026"></div>
<div class="field-group"><label>Police Station <span style="color:red;">*</span></label><input type="text" id="bPS"></div>
<p style="color:var(--text-secondary);font-size:13px;">${files.length} image(s) selected</p>
<div class="popup-actions"><button class="popup-cancel" onclick="closePopup()">Cancel</button><button class="popup-confirm" onclick="saveBailBond()">Save</button></div>`);
        document.getElementById('entryPopup')._files=files;
    };input.click();
}
async function saveBailBond(){
    const fir=(document.getElementById('bFir').value||'').trim(),yr=(document.getElementById('bYear').value||'').trim(),ps=(document.getElementById('bPS').value||'').trim();
    if(!fir||!yr||!ps){alert('Please fill all fields!');return;}
    const files=document.getElementById('entryPopup')._files;closePopup();
    showLoading(`Processing 1 of ${files.length} images...`);
    const images=[];
    for(let i=0;i<files.length;i++){document.getElementById('loadingText').textContent=`Processing ${i+1} of ${files.length} images...`;const c=await fileToCompressed(files[i]);if(c)images.push(c);}
    try{const bonds=JSON.parse(cacheGet('bailBonds')||'[]');bonds.push({title:`FIR ${fir}/${yr}`,firNumber:fir,firYear:yr,policeStation:ps,images,createdAt:new Date().toISOString()});await dbSet('bailBonds',JSON.stringify(bonds));hideLoading();openBailBonds();loadCounts();}
    catch(e){hideLoading();alert('Save failed: '+e.message);}
}
function viewBailBond(i){
    const b=JSON.parse(cacheGet('bailBonds')||'[]')[i];
    let imgs=(b.images||[]).map(src=>`<div style="margin-bottom:12px;"><img src="${src}" style="width:100%;border-radius:10px;display:block;cursor:pointer;" onclick="showImgPrev(this)" data-src="${src.replace(/"/g,'&quot;')}"></div>`).join('');
    const dv=document.getElementById('detailView');
    dv.innerHTML=`<div class="detail-header"><button class="back-btn" onclick="openBailBonds()">‚Üê</button><h2>${esc(b.title)}</h2></div>
<p style="color:var(--text-secondary);font-size:13px;margin-bottom:4px;padding:0 4px;"><strong>FIR:</strong> ${esc(b.firNumber)}/${esc(b.firYear)}</p>
<p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;padding:0 4px;"><strong>Police Station:</strong> ${esc(b.policeStation)}</p>
<p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;padding:0 4px;">${(b.images||[]).length} image(s)</p>
${imgs}`;
    pageShow(dv);
}
async function deleteBailBond(i){
    if(!pwConfirm('Delete this bail bond?'))return;
    const bonds=JSON.parse(cacheGet('bailBonds')||'[]');bonds.splice(i,1);await dbSet('bailBonds',JSON.stringify(bonds));openBailBonds();loadCounts();
}
async function shareBailBond(i){
    const b=JSON.parse(cacheGet('bailBonds')||'[]')[i];
    if(!navigator.share){alert('Sharing not supported');return;}
    const imgs=(b.images||[]);
    try{
        if(imgs.length){
            const files=await Promise.all(imgs.map(async(src,idx)=>{
                const res=await fetch(src);const blob=await res.blob();
                return new File([blob],`FIR_${b.firNumber}_${idx+1}.jpg`,{type:blob.type||'image/jpeg'});
            }));
            if(navigator.canShare&&navigator.canShare({files})){await navigator.share({title:b.title,files});return;}
        }
        await navigator.share({title:b.title,text:`FIR: ${b.firNumber}/${b.firYear}\nPolice Station: ${b.policeStation}\n${imgs.length} image(s)`});
    }catch(e){if(e.name!=='AbortError')alert('Share failed: '+e.message);}
}

// ============================================================
//  RECORD
// ============================================================
function openRecord(fromBack){
    if(!fromBack)pushNav('record',{});
    const folders=JSON.parse(cacheGet('record_folders')||'[]');
    let html=`<div class="detail-header"><button class="back-btn" onclick="closeDetail()">‚Üê</button><h2>Record</h2></div>`;
    folders.forEach((f,i)=>html+=`<div class="folder-card" data-idx="${i}" onclick="openRecordFolder(${i})"><div class="folder-icon">üìÅ</div><div class="folder-info"><div class="folder-name">${esc(f.month)} ${esc(f.year)}</div><div class="folder-count" style="color:var(--text-primary);font-size:13px;">${esc(f.judgeName)}</div><div class="folder-count">${(f.cases||[]).length} case(s)</div></div><div class="folder-arrow">‚Ä∫</div></div>`);
    if(folders.length<20)html+=`<button class="add-folder-btn" onclick="createRecFolder()">+ Add Folder</button>`;
    if(!folders.length)html+=`<div class="empty-state"><div class="empty-state-icon">üìÅ</div><p>No folders yet</p></div>`;
    html+=`<p class="long-press-hint">Long press on folder for options</p>`;
    const dv=document.getElementById('detailView');dv.innerHTML=html;hideDashboard();setTimeout(()=>pageShow(dv),60);
    setTimeout(()=>dv.querySelectorAll('.folder-card').forEach(c=>{const i=parseInt(c.getAttribute('data-idx'));setupLP(c,{type:'folder',category:'record',folderIndex:i});}),100);
}
function createRecFolder(){
    showEntryPopup(`<h2 style="color:var(--text-primary);margin-bottom:15px;">Create Record Folder</h2>
<div class="field-group"><label>Select Month <span style="color:red;">*</span></label><select id="rMonth">${['January','February','March','April','May','June','July','August','September','October','November','December'].map(m=>`<option value="${m}">${m}</option>`).join('')}</select></div>
<div class="field-group"><label>Select Year <span style="color:red;">*</span></label><input type="number" id="rYear" value="2026"></div>
<div class="field-group"><label>Judge Name <span style="color:red;">*</span></label><input type="text" id="rJudge"></div>
<div class="popup-actions"><button class="popup-cancel" onclick="closePopup()">Cancel</button><button class="popup-confirm" onclick="saveRecFolder()">Create Folder</button></div>`);
}
async function saveRecFolder(){
    const month=document.getElementById('rMonth').value,year=(document.getElementById('rYear').value||'').trim(),judgeName=(document.getElementById('rJudge').value||'').trim();
    if(!month||!year||!judgeName){alert('Please fill all fields!');return;}
    const folders=JSON.parse(cacheGet('record_folders')||'[]');if(folders.length>=20){alert('Maximum 20 folders allowed!');return;}
    folders.push({month,year,judgeName,cases:[],createdAt:new Date().toISOString()});
    await dbSet('record_folders',JSON.stringify(folders));closePopup();openRecord();loadCounts();
}
function openRecordFolder(fi,fromBack){
    if(!fromBack)pushNav('recordFolder',{folderIndex:fi});
    const folders=JSON.parse(cacheGet('record_folders')||'[]'),folder=folders[fi];
    let html=`<div class="detail-header"><button class="back-btn" onclick="openRecord()">‚Üê</button><div><h2 style="margin:0;">${esc(folder.month)} ${esc(folder.year)}</h2><div style="font-size:13px;color:var(--text-secondary);">${esc(folder.judgeName)}</div></div><button onclick="showRecAddMenu(${fi})" style="margin-left:auto;background:#2563eb;color:white;border:none;border-radius:8px;padding:6px 14px;font-size:20px;cursor:pointer;font-weight:700;">+</button></div>
<div class="search-container"><input type="text" class="search-input" id="caseSearch" placeholder="üîç Search..." oninput="srchRecCases()"></div>`;
    (folder.cases||[]).forEach((c,ci)=>{const s=buildSrch(c);html+=`<div class="document-card" data-idx="${ci}" data-s="${esc(s)}" onclick="viewRecCase(${fi},${ci})"><div class="doc-icon">‚öñÔ∏è</div><div class="doc-info"><div class="doc-name">${esc(c.title)}</div><div class="doc-date">${esc((c.caseType||'CASE').toUpperCase())} - ${esc(String(c.pages||0))} pages</div></div></div>`;});

    if(!(folder.cases||[]).length)html+=`<div class="empty-state"><div class="empty-state-icon">‚öñÔ∏è</div><p>No cases yet</p></div>`;
    html+=`<p class="long-press-hint">Click to view ‚Ä¢ Long press for options</p>`;
    const dv=document.getElementById('detailView');dv.innerHTML=html;dv.dataset.cf=fi;
    setTimeout(()=>dv.querySelectorAll('.document-card').forEach(c=>{const ci=parseInt(c.getAttribute('data-idx'));setupLP(c,{type:'recordCase',folderIndex:fi,index:ci});}),100);
}
function showRecAddMenu(fi){
    showEntryPopup(`<h2 style="color:var(--text-primary);margin-bottom:20px;">Add Document</h2>
<div class="popup-actions" style="flex-direction:column;gap:12px;">
    <button class="popup-confirm" style="width:100%;font-size:16px;" onclick="closePopup();addRecPic(${fi})">üì∑ Picture</button>
    <button class="popup-confirm" style="width:100%;font-size:16px;background:#8b5cf6;" onclick="closePopup();addRecCase(${fi})">üìù Entry Form</button>
    <button class="popup-cancel" style="width:100%;" onclick="closePopup()">Cancel</button>
</div>`);
}
function buildSrch(c){return[(c.title||''),(c.firNumber||''),(c.firYear||''),(c.policeStation||''),(c.offence||''),(c.decisionDate||''),(c.nature||''),(c.goshwaraNumber||'')].join(' ').toLowerCase();}
function srchRecCases(){const q=(document.getElementById('caseSearch').value||'').toLowerCase();document.querySelectorAll('.document-card').forEach(c=>c.style.display=(c.getAttribute('data-s')||'').includes(q)?'flex':'none');}
function addRecPic(fi){
    const input=document.createElement('input');input.type='file';input.accept='image/*';input.multiple=true;
    input.onchange=async e=>{
        const files=Array.from(e.target.files);if(!files.length)return;
        showLoading(`Processing 1 of ${files.length} images...`);
        const images=[];
        for(let i=0;i<files.length;i++){document.getElementById('loadingText').textContent=`Processing ${i+1} of ${files.length}...`;const c=await fileToCompressed(files[i]);if(c)images.push(c);}
        try{const folders=JSON.parse(cacheGet('record_folders')||'[]');folders[fi].cases.push({title:'Picture Entry '+new Date().toLocaleString(),caseType:'picture',images,hasImages:true,pages:images.length,createdAt:new Date().toISOString()});await dbSet('record_folders',JSON.stringify(folders));hideLoading();openRecordFolder(fi);loadCounts();}
        catch(e){hideLoading();alert('Save failed: '+e.message);}
    };input.click();
}
function addRecCase(fi){
    const saved=cacheGet('lastCaseType')||'criminal';
    showEntryPopup(`<h2 style="color:var(--text-primary);margin-bottom:15px;">Add Case Entry</h2>
<div class="field-group"><label>Case Type:</label><select id="caseType" onchange="updRecFields()"><option value="criminal" ${saved==='criminal'?'selected':''}>Criminal</option><option value="civil" ${saved==='civil'?'selected':''}>Civil</option></select></div>
<div id="caseFields"></div>
<div class="popup-actions"><button class="popup-cancel" onclick="closePopup()">Cancel</button><button class="popup-confirm" onclick="saveRecCase(${fi})">Save Case</button></div>`);
    updRecFields();
}
function updRecFields(){
    const ct=document.getElementById('caseType').value;dbSet('lastCaseType',ct);
    const c=document.getElementById('caseFields');if(!c)return;
    if(ct==='criminal')c.innerHTML=`<div class="field-group"><label>Title <span style="color:red;">*</span></label><input type="text" id="cTitle"></div><div class="field-group"><label>Goshwara Number</label><input type="text" id="cGosh" placeholder="Optional"></div><div class="field-group"><label>FIR Number <span style="color:red;">*</span></label><input type="text" id="cFir"></div><div class="field-group"><label>FIR Year <span style="color:red;">*</span></label><input type="text" id="cYear" value="2026"></div><div class="field-group"><label>Offence <span style="color:red;">*</span></label><input type="text" id="cOff"></div><div class="field-group"><label>Police Station <span style="color:red;">*</span></label><input type="text" id="cPS"></div><div class="field-group"><label>Decision Date <span style="color:red;">*</span></label><input type="date" id="cDate"></div><div class="field-group"><label>Pages <span style="color:red;">*</span></label><input type="number" id="cPages"></div>`;
    else c.innerHTML=`<div class="field-group"><label>Title <span style="color:red;">*</span></label><input type="text" id="cTitle"></div><div class="field-group"><label>Goshwara Number</label><input type="text" id="cGosh" placeholder="Optional"></div><div class="field-group"><label>Nature <span style="color:red;">*</span></label><input type="text" id="cNature"></div><div class="field-group"><label>Decision Date <span style="color:red;">*</span></label><input type="date" id="cDate"></div><div class="field-group"><label>Pages <span style="color:red;">*</span></label><input type="number" id="cPages"></div>`;
}
async function saveRecCase(fi){
    const ct=document.getElementById('caseType').value,title=(document.getElementById('cTitle').value||'').trim(),date=document.getElementById('cDate').value,pages=document.getElementById('cPages').value,gosh=(document.getElementById('cGosh').value||'').trim();
    if(!title||!date||!pages){alert('Please fill all required fields!');return;}
    let cd={caseType:ct,title,decisionDate:date,pages,goshwaraNumber:gosh,createdAt:new Date().toISOString()};
    if(ct==='criminal'){const fir=(document.getElementById('cFir').value||'').trim(),yr=(document.getElementById('cYear').value||'').trim(),ps=(document.getElementById('cPS').value||'').trim(),off=(document.getElementById('cOff').value||'').trim();if(!fir||!yr||!ps||!off){alert('Please fill all required fields!');return;}Object.assign(cd,{firNumber:fir,firYear:yr,policeStation:ps,offence:off});}
    else{const nat=(document.getElementById('cNature').value||'').trim();if(!nat){alert('Please fill all required fields!');return;}cd.nature=nat;}
    showLoading('Saving case...');
    const folders=JSON.parse(cacheGet('record_folders')||'[]');folders[fi].cases.push(cd);await dbSet('record_folders',JSON.stringify(folders));
    hideLoading();closePopup();openRecordFolder(fi);loadCounts();
}
function viewRecCase(fi,ci){
    const cd=JSON.parse(cacheGet('record_folders')||'[]')[fi].cases[ci];
    const dv=document.getElementById('detailView');
    let inner='';
    if(cd.hasImages&&cd.images&&cd.caseType==='picture'){
        const imgs=(cd.images||[]).map(src=>`<div style="margin-bottom:12px;"><img src="${src}" style="width:100%;border-radius:10px;display:block;cursor:pointer;" onclick="showImgPrev(this)" data-src="${src.replace(/"/g,'&quot;')}"></div>`).join('');
        inner=`<div class="detail-header"><button class="back-btn" onclick="openRecordFolder(${fi})">‚Üê</button><h2>Picture Entry</h2></div><p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;padding:0 4px;">${(cd.images||[]).length} image(s)</p>${imgs}`;
    } else {
        let info=`<div class="form-section" style="margin-bottom:12px;">`;
        info+=`<p style="margin:6px 0;"><strong>Case Type:</strong> ${esc((cd.caseType||'').toUpperCase())}</p>`;
        if(cd.goshwaraNumber)info+=`<p style="margin:6px 0;"><strong>Goshwara No:</strong> ${esc(cd.goshwaraNumber)}</p>`;
        if(cd.caseType==='criminal'){info+=`<p style="margin:6px 0;"><strong>FIR:</strong> ${esc(cd.firNumber||'')}/${esc(cd.firYear||'')}</p><p style="margin:6px 0;"><strong>Offence:</strong> ${esc(cd.offence||'')}</p><p style="margin:6px 0;"><strong>Police Station:</strong> ${esc(cd.policeStation||'')}</p>`;}
        else info+=`<p style="margin:6px 0;"><strong>Nature:</strong> ${esc(cd.nature||'')}</p>`;
        info+=`<p style="margin:6px 0;"><strong>Decision Date:</strong> ${esc(cd.decisionDate||'')}</p><p style="margin:6px 0;"><strong>Pages:</strong> ${esc(String(cd.pages||0))}</p></div>`;
        const imgs=(cd.hasImages&&cd.images)?(cd.images||[]).map(src=>`<div style="margin-bottom:12px;"><img src="${src}" style="width:100%;border-radius:10px;display:block;cursor:pointer;" onclick="showImgPrev(this)" data-src="${src.replace(/"/g,'&quot;')}"></div>`).join(''):'';
        inner=`<div class="detail-header"><button class="back-btn" onclick="openRecordFolder(${fi})">‚Üê</button><h2>${esc(cd.title)}</h2></div>${info}${imgs}`;
    }
    dv.innerHTML=inner;
    pageShow(dv);
}
function editRecordCase(fi,ci){
    const cd=JSON.parse(cacheGet('record_folders')||'[]')[fi].cases[ci];
    let f=`<div class="field-group"><label>Title <span style="color:red;">*</span></label><input type="text" id="eTitle" value="${esc(cd.title||'')}"></div><div class="field-group"><label>Goshwara Number</label><input type="text" id="eGosh" value="${esc(cd.goshwaraNumber||'')}"></div>`;
    if(cd.caseType==='criminal')f+=`<div class="field-group"><label>FIR Number</label><input type="text" id="eFir" value="${esc(cd.firNumber||'')}"></div><div class="field-group"><label>FIR Year</label><input type="text" id="eYear" value="${esc(cd.firYear||'')}"></div><div class="field-group"><label>Offence</label><input type="text" id="eOff" value="${esc(cd.offence||'')}"></div><div class="field-group"><label>Police Station</label><input type="text" id="ePS" value="${esc(cd.policeStation||'')}"></div>`;
    else f+=`<div class="field-group"><label>Nature</label><input type="text" id="eNature" value="${esc(cd.nature||'')}"></div>`;
    f+=`<div class="field-group"><label>Decision Date</label><input type="date" id="eDate" value="${esc(cd.decisionDate||'')}"></div><div class="field-group"><label>Pages</label><input type="number" id="ePages" value="${esc(String(cd.pages||''))}"></div>`;
    showEntryPopup(`<h2 style="color:var(--text-primary);margin-bottom:15px;">Edit Case</h2>${f}<div class="popup-actions"><button class="popup-cancel" onclick="closePopup()">Cancel</button><button class="popup-confirm" onclick="updateRecCase(${fi},${ci})">Update</button></div>`);
}
async function updateRecCase(fi,ci){
    const folders=JSON.parse(cacheGet('record_folders')||'[]'),cd=folders[fi].cases[ci];
    cd.title=(document.getElementById('eTitle').value||'').trim();cd.goshwaraNumber=(document.getElementById('eGosh').value||'').trim();cd.decisionDate=document.getElementById('eDate').value;cd.pages=document.getElementById('ePages').value;
    if(cd.caseType==='criminal'){cd.firNumber=(document.getElementById('eFir').value||'').trim();cd.firYear=(document.getElementById('eYear').value||'').trim();cd.offence=(document.getElementById('eOff').value||'').trim();cd.policeStation=(document.getElementById('ePS').value||'').trim();}
    else cd.nature=(document.getElementById('eNature').value||'').trim();
    await dbSet('record_folders',JSON.stringify(folders));closePopup();openRecordFolder(fi);loadCounts();
}
async function deleteRecordCase(fi,ci){
    if(!pwConfirm('Delete this case?'))return;
    const folders=JSON.parse(cacheGet('record_folders')||'[]');folders[fi].cases.splice(ci,1);await dbSet('record_folders',JSON.stringify(folders));openRecordFolder(fi);loadCounts();
}
async function shareRecordCase(fi,ci){
    const fld=JSON.parse(cacheGet('record_folders')||'[]')[fi];
    const cd=fld.cases[ci];
    if(!navigator.share){alert('Sharing not supported');return;}
    try{
        if(cd.caseType==='picture'&&cd.images&&cd.images.length){
            const files=await Promise.all(cd.images.map(async(src,idx)=>{
                const res=await fetch(src);const blob=await res.blob();
                return new File([blob],`Record_${idx+1}.jpg`,{type:blob.type||'image/jpeg'});
            }));
            if(navigator.canShare&&navigator.canShare({files})){await navigator.share({title:'Picture Entry',files});return;}
        }
        let text=`Title: ${cd.title}\nCase Type: ${cd.caseType}`;
        if(cd.goshwaraNumber)text+=`\nGoshwara No: ${cd.goshwaraNumber}`;
        if(cd.caseType==='criminal')text+=`\nFIR: ${cd.firNumber}/${cd.firYear}\nPolice Station: ${cd.policeStation}\nOffence: ${cd.offence||''}`;
        else text+=`\nNature: ${cd.nature||''}`;
        text+=`\nDecision Date: ${cd.decisionDate}\nPages: ${cd.pages}`;
        text+=`\nFolder: ${fld.month} ${fld.year} - Judge: ${fld.judgeName}`;
        await navigator.share({title:cd.title,text});
    }catch(e){if(e.name!=='AbortError')alert('Share failed: '+e.message);}
}

// ============================================================
//  MY DOCUMENT global upload handlers
// ============================================================
async function handleDocFileInput(e){
    const files=Array.from(e.target.files);e.target.value='';if(!files.length)return;
    let folders=JSON.parse(cacheGet('englishFile_folders')||'[]');
    if(!folders.length){folders.push({name:'Default',documents:[],createdAt:new Date().toISOString()});await dbSet('englishFile_folders',JSON.stringify(folders));_cache['englishFile_folders']=JSON.stringify(folders);}
    // Show title prompt then save all files together
    showEntryPopup(`
        <h2 style="color:var(--text-primary);margin-bottom:12px;">Document Title</h2>
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;text-align:center;">${files.length} image(s) selected</p>
        <div class="field-group"><label>Document Title <span style="color:red;">*</span></label><input type="text" id="engDocTitle" placeholder="Enter document title" autofocus></div>
        <div class="popup-actions">
            <button class="popup-cancel" onclick="closePopup()">Cancel</button>
            <button class="popup-confirm" onclick="engDocSaveAll(0)">Save</button>
        </div>`);
    document.getElementById('entryPopup')._files=files;
}
async function handleDocCamInput(e){
    const file=e.target.files[0];e.target.value='';if(!file)return;
    const folders=JSON.parse(cacheGet('englishFile_folders')||'[]');
    if(!folders.length){folders.push({name:'Default',documents:[],createdAt:new Date().toISOString()});await dbSet('englishFile_folders',JSON.stringify(folders));}
    await engDocFlow([file],0,0);
}

// ============================================================
//  PROCESSING
// ============================================================
function openProcessing(){
    closeSidebar();
    showEntryPopup(`<div style="text-align:center;padding:10px 0;">
        <div style="font-size:48px;margin-bottom:12px;">‚öñÔ∏è</div>
        <h2 style="color:var(--text-primary);margin-bottom:10px;">Processing (ÿßÿ¨ÿ±ÿßÿ¶€å)</h2>
        <p style="color:var(--text-secondary);font-size:14px;line-height:1.6;">€å€Å ŸÅ€å⁄Üÿ± ÿ¨ŸÑÿØ ÿ¢ŸÜ€í ŸàÿßŸÑÿß €Å€í€î<br>Coming Soon!</p>
        <div class="popup-actions" style="margin-top:20px;">
            <button class="popup-confirm" onclick="closePopup()">OK</button>
        </div>
    </div>`);
}

// ============================================================
//  IMPORT / EXPORT
// ============================================================
async function exportData(){
    const KEYS=['filesOut','overdueFiles','returnedFiles','pendingTasks','overdueTasks','completedTasks','materialsOut','materialsOverdue','materialsReturned','englishFile_folders','bailBonds','record_folders'];
    const data={};KEYS.forEach(k=>{data[k]=JSON.parse(cacheGet(k)||'[]');});data.exportDate=new Date().toISOString();
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='muhafiz-backup-'+Date.now()+'.json';a.click();URL.revokeObjectURL(url);
    closeSidebar();alert('‚úì Data exported successfully!');
}
function importData(){document.getElementById('importFileInput').click();closeSidebar();}
async function handleImportFile(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=async ev=>{
        try{
            const data=JSON.parse(ev.target.result);
            showLoading('Importing data...');
            for(const k of Object.keys(data)){if(k!=='exportDate')await dbSet(k,JSON.stringify(data[k]));}
            hideLoading();loadCounts();alert('‚úì Data imported successfully!');
        }catch(err){hideLoading();alert('Error: Invalid file format!');}
    };
    reader.readAsText(file);e.target.value='';
}
</script>
<script>
// Service Worker Register
if('serviceWorker' in navigator){
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW error:', err));
    });
}
</script>
</body>
</html>
